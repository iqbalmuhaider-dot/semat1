<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MainApp - Portal Sekolah</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Babel (Untuk compile React dalam browser) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Import Map: Membolehkan import module berfungsi dalam HTML -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.292.0",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
      }
    }
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { 
          getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged 
        } from 'firebase/auth';
        import { 
          getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, query, writeBatch, updateDoc, getDoc, setDoc, getDocs, where 
        } from 'firebase/firestore';
        import { 
          LayoutDashboard, LogOut, ChevronRight, X, Search, 
          Link as LinkIcon, ExternalLink, Lock, FileSpreadsheet, Plus, Trash2,
          BookOpen, Calculator, FlaskConical, Languages, 
          Trophy, Users, Palette, Utensils, Bus, Library, 
          MonitorPlay, Code2, GraduationCap, ShieldCheck, 
          Briefcase, Globe, AlertCircle, Save, Info, Edit3, CheckSquare, Square, XCircle, CheckCircle, User, Loader2
        } from 'lucide-react';

        // --- KONFIGURASI FIREBASE ---
        const firebaseConfig = {
          apiKey: "AIzaSyDlx-fjKX3XZyECCfbz7-wl1kyfZSElI6Q",
          authDomain: "sistemapp.firebaseapp.com",
          projectId: "sistemapp",
          storageBucket: "sistemapp.firebasestorage.app",
          messagingSenderId: "412733274428",
          appId: "1:412733274428:web:394977e1390b4d016ec639",
          measurementId: "G-DMP5MRMP5P"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const googleProvider = new GoogleAuthProvider();

        // --- Pustaka Ikon ---
        const ICONS = {
          umum: {
            dashboard: { i: LayoutDashboard, color: 'text-blue-600', bg: 'bg-blue-50' },
            portal: { i: Globe, color: 'text-indigo-600', bg: 'bg-indigo-50' },
            admin: { i: ShieldCheck, color: 'text-slate-600', bg: 'bg-slate-100' },
          },
          akademik: {
            buku: { i: BookOpen, color: 'text-emerald-600', bg: 'bg-emerald-50' },
            math: { i: Calculator, color: 'text-violet-600', bg: 'bg-violet-50' },
            sains: { i: FlaskConical, color: 'text-teal-600', bg: 'bg-teal-50' },
            bahasa: { i: Languages, color: 'text-rose-600', bg: 'bg-rose-50' },
          },
          koko: {
            sukan: { i: Trophy, color: 'text-orange-600', bg: 'bg-orange-50' },
            seni: { i: Palette, color: 'text-pink-600', bg: 'bg-pink-50' },
            kelab: { i: Users, color: 'text-cyan-600', bg: 'bg-cyan-50' },
          },
          fasiliti: {
            kantin: { i: Utensils, color: 'text-yellow-600', bg: 'bg-yellow-50' },
            bas: { i: Bus, color: 'text-blue-800', bg: 'bg-blue-100' },
            ps: { i: Library, color: 'text-amber-700', bg: 'bg-amber-50' },
          }
        };
        const ALL_ICONS = {};
        Object.values(ICONS).forEach(cat => Object.assign(ALL_ICONS, cat));

        // --- KOMPONEN UTAMA ---
        function MainApp() {
          const [user, setUser] = useState(null); 
          const [userData, setUserData] = useState(null); 
          const [loading, setLoading] = useState(true);
          const [view, setView] = useState('dashboard'); // Lifted State for Navigation
          
          const [apps, setApps] = useState([]);
          const [students, setStudents] = useState([]);
          const [teachers, setTeachers] = useState([]);

          // 1. LOGIK AUTH & SECURITY (KEMASKINI)
          useEffect(() => {
            const unsub = onAuthStateChanged(auth, async (currentUser) => {
              if (currentUser) {
                try {
                    // A. SUPER ADMIN BYPASS
                    if (currentUser.uid === "eNs6hJfU3CXVjpfRmYiBBRCzPI03") {
                         const ref = doc(db, 'portal_users', currentUser.uid);
                         const superData = { 
                             name: currentUser.displayName || "Super Admin", 
                             email: currentUser.email, 
                             photo: currentUser.photoURL, 
                             role: 'admin',
                             isSuperAdmin: true,
                             createdAt: new Date().toISOString()
                         };
                         // Force update/create super admin
                         await setDoc(ref, superData, { merge: true });
                         
                         setUser(currentUser);
                         setUserData(superData);
                         syncToLocalStorage(currentUser, 'admin');
                         setLoading(false);
                         return; // Keluar dari function, akses diberi
                    }

                    // B. SEMAK USER SEDIA ADA
                    const userRef = doc(db, 'portal_users', currentUser.uid);
                    const userSnap = await getDoc(userRef);

                    if (userSnap.exists()) {
                        // User lama yang sah
                        const data = userSnap.data();
                        setUser(currentUser);
                        setUserData(data);
                        syncToLocalStorage(currentUser, data.role);
                        setLoading(false);
                    } else {
                        // C. USER BARU - SEMAK WHITELIST (SENARAI GURU)
                        const q = query(collection(db, 'portal_teachers'), where("email", "==", currentUser.email));
                        const querySnapshot = await getDocs(q);

                        if (!querySnapshot.empty) {
                            // E-mel wujud dalam database guru! Benarkan masuk.
                            const teacherInfo = querySnapshot.docs[0].data();
                            
                            // Tentukan role (default guru, tapi jika data kata admin, bagi admin)
                            const assignedRole = (teacherInfo.role && teacherInfo.role.toLowerCase() === 'admin') ? 'admin' : 'guru';

                            const newUserData = {
                                name: teacherInfo.name, // Guna nama rasmi dari DB
                                email: currentUser.email,
                                photo: currentUser.photoURL,
                                role: assignedRole,
                                createdAt: new Date().toISOString()
                            };

                            await setDoc(userRef, newUserData);
                            setUser(currentUser);
                            setUserData(newUserData);
                            syncToLocalStorage(currentUser, assignedRole);
                            setLoading(false);
                        } else {
                            // D. AKSES DITOLAK
                            await signOut(auth);
                            setUser(null);
                            setUserData(null);
                            localStorage.removeItem('portal_current_user');
                            alert("AKSES DITOLAK: E-mel anda tidak didaftarkan dalam sistem oleh Admin.");
                            setLoading(false);
                        }
                    }
                } catch(e) {
                    console.error("Auth Error:", e);
                    alert("Ralat Sistem: " + e.message);
                    await signOut(auth);
                    setLoading(false);
                }
              } else {
                setUser(null);
                setUserData(null);
                localStorage.removeItem('portal_current_user');
                setLoading(false);
              }
            });
            return () => unsub();
          }, []);

          const syncToLocalStorage = (u, r) => {
             localStorage.setItem('portal_current_user', JSON.stringify({
                name: u.displayName,
                email: u.email,
                role: r,
                photo: u.photoURL
             }));
          };

          useEffect(() => {
            if (!user || !userData) return;
            
            window.PortalAPI = { 
               currentUser: user, 
               saveData: async (colName, data) => {
                 try {
                    await addDoc(collection(db, colName), { ...data, createdAt: new Date().toISOString(), createdBy: user.uid });
                    return { success: true };
                 } catch(e) { return { success: false, error: e }; }
               }
            };

            const unsubApps = onSnapshot(query(collection(db, 'portal_apps')), s => setApps(s.docs.map(d => ({id: d.id, ...d.data()}))));
            let unsubStud = () => {}, unsubTeach = () => {};
            if (userData.role === 'admin' || userData.role === 'guru') {
               unsubStud = onSnapshot(query(collection(db, 'portal_students')), s => setStudents(s.docs.map(d => ({id: d.id, ...d.data()}))));
               unsubTeach = onSnapshot(query(collection(db, 'portal_teachers')), s => setTeachers(s.docs.map(d => ({id: d.id, ...d.data()}))));
            }
            return () => { unsubApps(); unsubStud(); unsubTeach(); };
          }, [user, userData]);

          const handleLogin = async () => {
             try { await signInWithPopup(auth, googleProvider); } 
             catch (error) { console.error(error); alert("Gagal log masuk."); }
          };

          const handleLogout = async () => { await signOut(auth); };

          if (loading) return <div className="h-screen flex flex-col items-center justify-center bg-slate-50 text-indigo-600"><Loader2 className="w-10 h-10 animate-spin mb-4"/><span className="font-medium animate-pulse">Menyemak kelayakan...</span></div>;

          if (!user) return <LoginScreen onGoogleLogin={handleLogin} />;

          if (!userData) return <div className="h-screen flex items-center justify-center">Memuatkan data pengguna...</div>;

          return (
            <div className="flex h-screen bg-[#F8FAFC] font-sans text-slate-900 overflow-hidden">
              <style>{styles}</style>
              <Sidebar userData={userData} view={view} setView={setView} logout={handleLogout} />
              <div className="flex-1 flex flex-col h-full overflow-hidden relative">
                <Header userData={userData} view={view} />
                <main className="flex-1 overflow-y-auto p-6 md:p-8 scroll-smooth">
                   {/* Router Logic Direct */}
                   {(() => {
                      if (['students','teachers','builder'].includes(view) && userData.role !== 'admin') return <AccessDenied />;
                      switch(view) {
                        case 'dashboard': return <Dashboard role={userData.role} apps={apps} students={students} teachers={teachers} setView={setView} />;
                        case 'apps': return <AppGallery apps={apps} />;
                        case 'builder': return <AppBuilder apps={apps} />;
                        case 'students': return <DataTable type="student" data={students} />;
                        case 'teachers': return <DataTable type="teacher" data={teachers} />;
                        default: return <Dashboard role={userData.role} apps={apps} students={students} teachers={teachers} setView={setView} />;
                      }
                   })()}
                </main>
              </div>
            </div>
          );
        }

        // --- SUB COMPONENTS (SAMA SEPERTI REACT ASAL) ---

        function LoginScreen({ onGoogleLogin }) {
          return (
            <div className="min-h-screen flex bg-white animate-fade-in">
              <div className="hidden lg:flex w-5/12 bg-slate-900 p-12 flex-col justify-between relative overflow-hidden">
                 <div className="absolute top-0 right-0 w-64 h-64 bg-indigo-600 rounded-full blur-[80px] opacity-20 -translate-y-1/2 translate-x-1/2"></div>
                 <div className="absolute bottom-0 left-0 w-64 h-64 bg-blue-600 rounded-full blur-[80px] opacity-20 translate-y-1/2 -translate-x-1/2"></div>
                 <div className="relative z-10"><div className="flex items-center gap-3 mb-6"><div className="w-10 h-10 bg-indigo-600 rounded-lg flex items-center justify-center text-white shadow-lg"><LayoutDashboard className="w-6 h-6"/></div><span className="text-xl font-bold text-white tracking-tight">MainApp</span></div><h1 className="text-4xl font-bold text-white leading-tight mb-4">Portal Sekolah<br/>Selamat & Pintar</h1><p className="text-slate-400 text-lg">Log masuk menggunakan akaun Google rasmi anda.</p></div>
                 <div className="relative z-10 text-xs text-slate-600">Sistem dijana oleh Firebase Auth</div>
              </div>
              <div className="w-full lg:w-7/12 flex items-center justify-center p-8 bg-slate-50">
                 <div className="max-w-md w-full bg-white p-10 rounded-2xl shadow-xl shadow-slate-200/50 border border-slate-100 text-center">
                    <div className="w-16 h-16 bg-blue-50 rounded-full flex items-center justify-center mx-auto mb-6 text-blue-600"><Lock className="w-8 h-8"/></div>
                    <h2 className="text-2xl font-bold text-slate-800 mb-2">Selamat Datang</h2>
                    <p className="text-slate-500 mb-8">Akses akaun anda dengan selamat.</p>
                    <button onClick={onGoogleLogin} className="w-full flex items-center justify-center gap-3 p-4 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 hover:border-slate-300 transition-all group shadow-sm">
                       <img src="https://www.svgrepo.com/show/475656/google-color.svg" className="w-6 h-6" alt="Google" />
                       <span className="font-bold text-slate-700">Teruskan dengan Google</span>
                    </button>
                    <p className="mt-6 text-xs text-slate-400 max-w-xs mx-auto">
                       Hanya e-mel yang didaftarkan oleh Admin sahaja dibenarkan akses.
                    </p>
                 </div>
              </div>
            </div>
          );
        }

        function Sidebar({ userData, view, setView, logout }) {
          const menus = [
             { id: 'dashboard', l: 'Utama', i: LayoutDashboard, admin: false },
             { id: 'apps', l: 'Aplikasi', i: MonitorPlay, admin: false },
             { id: 'builder', l: 'Bina App', i: Code2, admin: true },
             { id: 'students', l: 'Data Murid', i: GraduationCap, admin: true },
             { id: 'teachers', l: 'Data Guru', i: Users, admin: true },
          ];
          return (
             <aside className="w-20 md:w-64 bg-white border-r border-slate-200 flex flex-col shrink-0 z-20">
                <div className="h-16 flex items-center justify-center md:justify-start md:px-6 border-b border-slate-100"><div className="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white font-bold text-xl">S</div><span className="ml-3 font-bold text-xl text-slate-800 hidden md:block">SistemApp</span></div>
                <div className="p-4 border-b border-slate-100 flex items-center gap-3">
                   <img src={userData.photo || "https://ui-avatars.com/api/?name="+userData.name} className="w-10 h-10 rounded-full border border-slate-200" alt="Avatar"/>
                   <div className="hidden md:block overflow-hidden"><p className="text-sm font-bold text-slate-700 truncate">{userData.name}</p><p className="text-xs text-slate-500 uppercase font-bold tracking-wider">{userData.role}</p></div>
                </div>
                <nav className="p-2 md:p-4 space-y-1 flex-1">
                   {menus.map(m => {
                      if (m.admin && userData.role !== 'admin') return null;
                      const active = view === m.id;
                      return <button key={m.id} onClick={() => setView(m.id)} title={m.l} className={`w-full flex items-center justify-center md:justify-start gap-3 px-3 py-3 rounded-lg text-sm font-medium transition-all ${active ? 'bg-indigo-50 text-indigo-700 shadow-sm border border-indigo-100' : 'text-slate-500 hover:bg-slate-50 border border-transparent'}`}><m.i className={`w-5 h-5 ${active ? 'text-indigo-600' : 'text-slate-400'}`} /><span className="hidden md:block">{m.l}</span></button>
                   })}
                </nav>
                <div className="p-4 border-t border-slate-100"><button onClick={logout} className="flex items-center justify-center md:justify-start gap-3 text-slate-400 hover:text-red-600 hover:bg-red-50 text-sm font-medium w-full px-3 py-3 rounded-lg transition-colors"><LogOut className="w-5 h-5" /><span className="hidden md:block">Keluar</span></button></div>
             </aside>
          )
        }

        function Header({ userData, view }) {
           return (
              <header className="h-16 bg-white border-b border-slate-200 px-6 flex items-center justify-between shrink-0 shadow-sm z-10">
                 <h2 className="font-bold text-lg capitalize text-slate-800 flex items-center gap-2">{view}</h2>
                 <span className="text-xs font-bold uppercase text-white bg-indigo-600 px-3 py-1 rounded-full tracking-wider shadow-sm">{userData.role}</span>
              </header>
           )
        }

        function Dashboard({ role, apps, students, teachers, setView }) {
          const showStats = role === 'admin' || role === 'guru';
          const stats = [
            { label: 'Aplikasi', val: apps.length, i: LayoutDashboard, c: 'text-blue-600', b: 'bg-blue-50' },
            { label: 'Murid', val: showStats ? students.length : '-', i: GraduationCap, c: 'text-emerald-600', b: 'bg-emerald-50' },
            { label: 'Guru', val: showStats ? teachers.length : '-', i: Users, c: 'text-indigo-600', b: 'bg-indigo-50' },
          ];
          return (
            <div className="max-w-6xl mx-auto space-y-8 animate-fade-in">
               <div className="bg-white rounded-xl p-8 border border-slate-200 shadow-sm"><h2 className="text-2xl font-bold text-slate-800 mb-2">Hai, {role}!</h2><p className="text-slate-500">Selamat datang ke papan pemuka.</p></div>
               <div className="grid grid-cols-1 md:grid-cols-3 gap-6">{stats.map((s, i) => (<div key={i} className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex items-center gap-4"><div className={`w-14 h-14 rounded-full flex items-center justify-center ${s.b} ${s.c}`}><s.i className="w-7 h-7" /></div><div><p className="text-sm font-medium text-slate-500">{s.label}</p><h3 className="text-3xl font-bold text-slate-800">{s.val}</h3></div></div>))}</div>
               <div>
                  <div className="flex items-center justify-between mb-6"><h3 className="text-lg font-bold text-slate-800">Aplikasi</h3><button onClick={() => setView('apps')} className="text-sm text-indigo-600 hover:underline">Lihat Semua</button></div>
                  <div className="grid grid-cols-1 md:grid-cols-4 gap-6">{apps.slice(0, 4).map(app => (<div key={app.id} onClick={() => setView('apps')} className="bg-white p-5 rounded-xl border border-slate-200 shadow-sm hover:shadow-md cursor-pointer"><h4 className="font-bold text-slate-800 mb-1">{app.title}</h4><p className="text-sm text-slate-500 line-clamp-2">{app.desc}</p></div>))}</div>
               </div>
            </div>
          );
        }

        // --- DATA TABLES ---
        function DataTable({ type, data }) {
          const [newRec, setNewRec] = useState({});
          const col = type === 'student' ? 'portal_students' : 'portal_teachers';
          const add = async (e) => { e.preventDefault(); if(newRec.name) { await addDoc(collection(db, col), newRec); setNewRec({}); } };
          const del = async (id) => { if(confirm("Padam?")) await deleteDoc(doc(db, col, id)); };
          return (<div className="grid lg:grid-cols-4 gap-8"><div className="bg-white p-6 rounded-xl border border-slate-200 h-fit"><h3 className="font-bold mb-4">Daftar {type}</h3><form onSubmit={add} className="space-y-4"><input className="inp" required value={newRec.name||''} onChange={e=>setNewRec({...newRec, name:e.target.value})} placeholder="Nama"/>{type==='student'?<input className="inp" required value={newRec.class||''} onChange={e=>setNewRec({...newRec, class:e.target.value})} placeholder="Kelas"/>:<><input className="inp" required value={newRec.email||''} onChange={e=>setNewRec({...newRec, email:e.target.value})} placeholder="Email"/><input className="inp" required value={newRec.role||''} onChange={e=>setNewRec({...newRec, role:e.target.value})} placeholder="Jawatan"/></>}<button className="w-full bg-slate-900 text-white py-2 rounded-lg font-bold">Simpan</button></form></div><div className="lg:col-span-3 bg-white rounded-xl border border-slate-200 overflow-hidden"><table className="w-full text-left text-sm"><thead className="bg-slate-50 text-slate-500 uppercase text-xs font-bold"><tr><th className="p-4">Nama</th><th className="p-4">Info</th><th className="p-4 text-right">Aksi</th></tr></thead><tbody className="divide-y divide-slate-100">{data.map(d=>(<tr key={d.id} className="hover:bg-slate-50"><td className="p-4 font-bold text-slate-700">{d.name}</td><td className="p-4 text-slate-500">{type==='student'?d.class:d.email}</td><td className="p-4 text-right"><button onClick={()=>del(d.id)} className="text-red-500"><Trash2 className="w-4 h-4"/></button></td></tr>))}</tbody></table></div></div>);
        }

        // --- APP BUILDER ---
        function AppBuilder({ apps }) {
          const [form, setForm] = useState({ title: '', desc: '', iconKey: 'portal', category: 'umum', type: 'link', content: '' });
          const [confirmDel, setConfirmDel] = useState(null);
          const handleSave = async () => { if(!form.title) return; await addDoc(collection(db, 'portal_apps'), form); setForm({...form, title:''}); alert("Disimpan!"); };
          const executeDelete = async () => { if(confirmDel) { await deleteDoc(doc(db, 'portal_apps', confirmDel)); setConfirmDel(null); } };
          return (<div className="grid lg:grid-cols-12 gap-8">
            <div className="lg:col-span-8 bg-white rounded-xl border border-slate-200 p-6">
                <h3 className="font-bold mb-4">Bina App</h3>
                <div className="space-y-4">
                    <input className="inp" value={form.title} onChange={e=>setForm({...form, title:e.target.value})} placeholder="Tajuk"/>
                    <textarea className="inp h-20" value={form.desc} onChange={e=>setForm({...form, desc:e.target.value})} placeholder="Deskripsi"/>
                    <div className="flex gap-2">
                        <button onClick={()=>setForm({...form, type:'link'})} className={`px-4 py-2 rounded text-xs font-bold border ${form.type==='link'?'bg-indigo-50 border-indigo-500 text-indigo-700':'border-slate-200'}`}>Link</button>
                        <button onClick={()=>setForm({...form, type:'html'})} className={`px-4 py-2 rounded text-xs font-bold border ${form.type==='html'?'bg-indigo-50 border-indigo-500 text-indigo-700':'border-slate-200'}`}>HTML</button>
                    </div>
                    {form.type==='link'?<input className="inp" value={form.content} onChange={e=>setForm({...form, content:e.target.value})} placeholder="URL..."/>:<textarea className="inp h-40 font-mono text-xs bg-slate-900 text-green-400" value={form.content} onChange={e=>setForm({...form, content:e.target.value})} placeholder="HTML Code..."/>}
                    
                    {/* ICON SELECTOR */}
                    <div className="flex gap-3 overflow-x-auto pb-4 pt-1">
                        {Object.entries(ALL_ICONS).map(([k, d]) => (
                            <button key={k} onClick={() => setForm({...form, iconKey: k})} className={`p-3 rounded-xl border transition-all flex-shrink-0 ${form.iconKey === k ? 'border-indigo-600 bg-indigo-50 ring-2 ring-indigo-200 shadow-sm' : 'border-slate-200 bg-white hover:border-slate-300 hover:bg-slate-50'}`} title={k}>
                                <d.i className={`w-6 h-6 ${d.color}`}/>
                            </button>
                        ))}
                    </div>

                    <button onClick={handleSave} className="bg-indigo-600 text-white w-full py-2 rounded-lg font-bold">Terbitkan</button>
                </div>
            </div>
            <div className="lg:col-span-4 bg-white rounded-xl border border-slate-200 p-4">
                <h3 className="font-bold text-sm mb-4">Senarai</h3>
                {apps.map(a=>(
                    <div key={a.id} className="flex justify-between items-center p-2 hover:bg-slate-50 border-b border-slate-100 last:border-0">
                        <span className="text-sm font-bold truncate w-40">{a.title}</span>
                        <button onClick={()=>setConfirmDel(a.id)} className="text-red-500"><Trash2 className="w-4 h-4"/></button>
                    </div>
                ))}
            </div>
            {confirmDel && <ConfirmModal title="Padam?" msg="Tiada undo." onConfirm={executeDelete} onCancel={()=>setConfirmDel(null)}/>}
          </div>);
        }

        function AppGallery({ apps }) {
          const [sel, setSel] = useState(null);
          
          if(sel) return (
            <div className="h-[80vh] bg-white rounded-xl border border-slate-200 flex flex-col">
                <div className="p-4 border-b flex justify-between">
                    <button onClick={()=>setSel(null)} className="flex items-center gap-1 font-bold text-slate-600"><ChevronRight className="rotate-180 w-4 h-4"/> Kembali</button>
                    <h3 className="font-bold">{sel.title}</h3>
                    {sel.type==='link' && <a href={sel.content} target="_blank" className="text-blue-600 text-xs font-bold flex items-center gap-1">Tab Baru <ExternalLink className="w-3 h-3"/></a>}
                </div>
                <div className="flex-1 relative bg-white">
                    {sel.type === 'html' ? (
                        <iframe 
                            srcDoc={sel.content} 
                            className="w-full h-full border-none" 
                            sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-modals"
                            title="SubApp Preview"
                        />
                    ) : (
                        <iframe 
                            src={sel.content} 
                            className="w-full h-full border-none" 
                            sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-modals"
                            title="External Link"
                        />
                    )}
                </div>
            </div>
          );

          return (
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                {apps.map(a=>(
                    <div key={a.id} onClick={()=>setSel(a)} className="bg-white p-4 rounded-xl border hover:shadow-md cursor-pointer flex flex-col h-40 justify-between">
                        <div className="flex justify-between">
                            <div className={`p-2 rounded-lg ${ALL_ICONS[a.iconKey]?.bg || 'bg-slate-100'}`}>
                                {React.createElement(ALL_ICONS[a.iconKey]?.i || Globe, { className: `w-6 h-6 ${ALL_ICONS[a.iconKey]?.color || 'text-slate-600'}` })}
                            </div>
                        </div>
                        <div>
                            <h4 className="font-bold truncate">{a.title}</h4>
                            <p className="text-xs text-slate-500 line-clamp-2">{a.desc}</p>
                        </div>
                    </div>
                ))}
            </div>
          );
        }

        function AccessDenied() { return <div className="h-full flex flex-col items-center justify-center text-slate-400 font-bold"><Lock className="w-12 h-12 mb-4 opacity-50"/><p>Akses Terhad</p></div>; }
        
        function ConfirmModal({ title, msg, onConfirm, onCancel }) { return <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50"><div className="bg-white p-6 rounded-xl w-80 shadow-2xl"><h3 className="font-bold text-lg mb-2">{title}</h3><p className="text-slate-500 mb-4 text-sm">{msg}</p><div className="flex justify-end gap-2"><button onClick={onCancel} className="px-4 py-2 rounded text-sm font-bold text-slate-600">Batal</button><button onClick={onConfirm} className="px-4 py-2 rounded text-sm font-bold bg-red-600 text-white">Ya</button></div></div></div>; }

        const styles = `.lbl{display:block;font-size:0.75rem;font-weight:700;color:#64748b;margin-bottom:0.5rem;text-transform:uppercase}.inp{width:100%;padding:0.6rem 0.8rem;border:1px solid #e2e8f0;border-radius:0.5rem;font-size:0.875rem;outline:none;background-color:#f8fafc;color:#1e293b}.inp:focus{background-color:white;border-color:#4f46e5}@keyframes fade-in{from{opacity:0}to{opacity:1}}@keyframes scale-up{from{transform:scale(0.95);opacity:0}to{transform:scale(1);opacity:1}}.animate-fade-in{animation:fade-in 0.2s ease-out}.animate-scale-up{animation:scale-up 0.2s cubic-bezier(0.16,1,0.3,1)}`;

        // RENDER ENTRY
        const root = createRoot(document.getElementById('root'));
        root.render(<MainApp />);
    </script>
</body>
</html>
