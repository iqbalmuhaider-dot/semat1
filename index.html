<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SkolaHub - SK Masjid Tanah</title>
    
    <!-- Library Pengimbas QR (Ditambah untuk fungsi Scan) -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

    <!-- Manifest untuk PWA (Data URI) -->
    <link rel="manifest" href="/manifest.webmanifest">
    <meta name="theme-color" content="#4f46e5">
    <link rel="apple-touch-icon" href="/icons/icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Import Map -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.292.0",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
      }
    }
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background-color: white; }
            .print-container { padding: 0; margin: 0; border: none; box-shadow: none; }
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Hide scrollbar for mobile nav */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Animations */
        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fade-in 0.3s ease-out; }
        .diagonal-stripe { 
            background-image: linear-gradient(45deg, #fcd34d 25%, #fbbf24 25%, #fbbf24 50%, #fcd34d 50%, #fcd34d 75%, #fbbf24 75%, #fbbf24 100%); 
            background-size: 10px 10px; 
        }
    </style>
</head>
	<script>
  	if ("serviceWorker" in navigator) {
    	navigator.serviceWorker.register("/sw.js");
  	}
</script>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { 
          getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, signInAnonymously 
        } from 'firebase/auth';
        import { 
          getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, query, writeBatch, updateDoc, getDoc, setDoc, getDocs, where, orderBy, limit 
        } from 'firebase/firestore';
        import { 
          LayoutDashboard, LogOut, ChevronRight, X, Search, 
          Link as LinkIcon, ExternalLink, Lock, FileSpreadsheet, Plus, Trash2,
          BookOpen, Calculator, FlaskConical, Languages, 
          Trophy, Users, Palette, Utensils, Bus, Library, 
          MonitorPlay, Code2, GraduationCap, ShieldCheck, 
          Briefcase, Globe, AlertCircle, Save, Info, Edit3, CheckSquare, Square, XCircle, CheckCircle, User, Loader2, Calendar, ChevronLeft, Flag, MapPin, CalendarDays, ClipboardList, Clock, AlertTriangle, FileText, Printer, Check, Settings, LogIn, UserCheck, PieChart, Filter, HelpCircle, Award, RotateCcw, History, RefreshCw, List, CalendarClock, QrCode, Copy, Camera, ChevronDown, Activity, BarChart3, Download, Share
        } from 'lucide-react';

        // --- SERVICE WORKER REGISTRATION (DIKEMBALIKAN UNTUK ANDROID) ---
        if ('serviceWorker' in navigator) {
            const swContent = `
                self.addEventListener('install', (e) => {
                    self.skipWaiting();
                });
                self.addEventListener('activate', (e) => {
                    return self.clients.claim();
                });
                self.addEventListener('fetch', (e) => {
                    // Placeholder fetch handler untuk memenuhi kriteria PWA
                });
            `;
            try {
                const blob = new Blob([swContent], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);
                
                navigator.serviceWorker.register(swUrl)
                    .then((reg) => console.log('SW Ready'))
                    .catch((err) => console.log('SW Fail (Mungkin disekat oleh preview):', err));
            } catch (e) {
                console.log('SW Setup Error:', e);
            }
        }

        // --- KONFIGURASI FIREBASE ---
        const firebaseConfig = {
          apiKey: "AIzaSyDlx-fjKX3XZyECCfbz7-wl1kyfZSElI6Q",
          authDomain: "sistemapp.firebaseapp.com",
          projectId: "sistemapp",
          storageBucket: "sistemapp.firebasestorage.app",
          messagingSenderId: "412733274428",
          appId: "1:412733274428:web:394977e1390b4d016ec639",
          measurementId: "G-DMP5MRMP5P"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const googleProvider = new GoogleAuthProvider();

        // --- ICONS & DATA ---
        const ICONS = {
          umum: { dashboard: { i: LayoutDashboard, color: 'text-blue-600', bg: 'bg-blue-50' }, portal: { i: Globe, color: 'text-indigo-600', bg: 'bg-indigo-50' }, admin: { i: ShieldCheck, color: 'text-slate-600', bg: 'bg-slate-100' } },
          akademik: { buku: { i: BookOpen, color: 'text-emerald-600', bg: 'bg-emerald-50' }, math: { i: Calculator, color: 'text-violet-600', bg: 'bg-violet-50' }, sains: { i: FlaskConical, color: 'text-teal-600', bg: 'bg-teal-50' }, bahasa: { i: Languages, color: 'text-rose-600', bg: 'bg-rose-50' } },
          koko: { sukan: { i: Trophy, color: 'text-orange-600', bg: 'bg-orange-50' }, seni: { i: Palette, color: 'text-pink-600', bg: 'bg-pink-50' }, kelab: { i: Users, color: 'text-cyan-600', bg: 'bg-cyan-50' } },
          fasiliti: { kantin: { i: Utensils, color: 'text-yellow-600', bg: 'bg-yellow-50' }, bas: { i: Bus, color: 'text-blue-800', bg: 'bg-blue-100' }, ps: { i: Library, color: 'text-amber-700', bg: 'bg-amber-50' } }
        };
        const ALL_ICONS = {}; Object.values(ICONS).forEach(cat => Object.assign(ALL_ICONS, cat));

        const KPM_EVENTS = [
            { start: '2026-01-12', end: '2026-03-20', type: 'school', title: 'Sesi Persekolahan Penggal 1' },
            { start: '2026-03-21', end: '2026-03-29', type: 'holiday', title: 'Cuti Penggal 1' },
            { start: '2026-03-30', end: '2026-05-22', type: 'school', title: 'Sambungan Penggal 1' },
            { start: '2026-05-23', end: '2026-06-07', type: 'holiday', title: 'Cuti Pertengahan Tahun' },
            { start: '2026-06-08', end: '2026-08-28', type: 'school', title: 'Sesi Persekolahan Penggal 2' },
            { start: '2026-08-29', end: '2026-09-06', type: 'holiday', title: 'Cuti Penggal 2' },
            { start: '2026-09-07', end: '2026-12-04', type: 'school', title: 'Sesi Persekolahan Penggal 3' },
            { start: '2026-12-05', end: '2026-12-31', type: 'holiday', title: 'Cuti Akhir Persekolahan' },
        ];

        const DEFAULT_TASKS = {
            pentadbiran: ["Guru Besar", "GPK Pentadbiran", "GPK HEM", "GPK Kokurikulum", "Guru Data", "Guru Bimbingan & Kaunseling", "Penyelaras ICT", "Guru Perpustakaan & Media (GPM)", "Penyelaras Prasekolah", "Penyelaras PPKI", "Penyelaras Bestari / Delima", "Pegawai Aset"],
            kurikulum: ["Setiausaha Kurikulum", "Setiausaha Peperiksaan / UASA", "Penyelaras PBD", "Penyelaras Jadual Waktu", "Penyelaras Transisi Tahun 1", "Penyelaras Pemulihan Khas", "Penyelaras TS25 / PAK21", "Penyelaras KBAT / i-Think", "Penyelaras HIP", "Penyelaras PLAN", "Penyelaras SPLKPM", "KP Bahasa Melayu", "KP Bahasa Inggeris", "KP Matematik", "KP Sains", "KP Pendidikan Islam", "KP Pendidikan Moral / B. Arab", "KP Sejarah", "KP RBT", "KP PSV / Muzik", "KP PJPK"],
            hem: ["Setiausaha HEM", "Penyelaras APDM / IDME", "Penyelaras SPBT", "Penyelaras RMT & Susu (PSS)", "Penyelaras Kantin", "Penyelaras 3K (Kebersihan, Kesihatan, Keselamatan)", "Penyelaras Disiplin & Pengawas", "Penyelaras BAP / KWAPM", "Penyelaras PPDa", "Penyelaras Kebajikan & Bantuan", "Penyelaras Penempatan (Ting 1 / SBP)"],
            kokurikulum: ["Setiausaha Kokurikulum", "Setiausaha Sukan", "Penyelaras PAJSK", "Penyelaras Unit Beruniform", "Penyelaras Kelab & Persatuan", "Penyelaras Sukan & Permainan", "Penyelaras Rumah Sukan", "Guru Penasihat Pengakap", "Guru Penasihat TKRS", "Guru Penasihat PPIM", "Guru Penasihat Tunas Puteri", "Guru Penasihat B. Melayu / Kebudayaan", "Guru Penasihat B. Inggeris", "Guru Penasihat Agama Islam", "Guru Penasihat STEM / Doktor Muda", "Guru Penasihat Rukun Negara", "Guru Penasihat Bola Sepak", "Guru Penasihat Bola Jaring", "Guru Penasihat Bola Baling", "Guru Penasihat Ping Pong", "Guru Penasihat Olahraga"],
            kelas: ["Guru Kelas Tahun 1", "Guru Kelas Tahun 2", "Guru Kelas Tahun 3", "Guru Kelas Tahun 4", "Guru Kelas Tahun 5", "Guru Kelas Tahun 6", "Guru Kelas Prasekolah", "Guru Kelas PPKI"]
        };

        // --- HELPER: DATE FORMATTER (DD/MM/YYYY) ---
        const formatDate = (dateString) => {
            if (!dateString) return "-";
            let cleanDate = dateString;
            if (typeof dateString === 'string' && dateString.includes('T')) {
                cleanDate = dateString.split('T')[0];
            }
            if (typeof cleanDate === 'string' && cleanDate.match(/^\d{2}\/\d{2}\/\d{4}$/)) return cleanDate;
            if (typeof cleanDate === 'string' && cleanDate.match(/^\d{4}-\d{2}-\d{2}$/)) {
                const [y, m, d] = cleanDate.split('-');
                return `${d}/${m}/${y}`;
            }
            const d = new Date(cleanDate);
            if (isNaN(d.getTime())) return dateString; 
            const day = d.getDate().toString().padStart(2, '0');
            const month = (d.getMonth() + 1).toString().padStart(2, '0');
            const year = d.getFullYear();
            return `${day}/${month}/${year}`;
        };

        // --- 1. UTILITY COMPONENTS ---

        function AccessDenied() { 
            return (
                <div className="h-full flex flex-col items-center justify-center text-slate-400 font-bold">
                    <Lock className="w-12 h-12 mb-4 opacity-50"/>
                    <p>Akses Terhad</p>
                </div>
            ); 
        }
        
        function ConfirmModal({ title, msg, onConfirm, onCancel }) { 
            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 animate-fade-in">
                    <div className="bg-white p-6 rounded-xl w-80 shadow-2xl">
                        <h3 className="font-bold text-lg mb-2 text-slate-800">{title}</h3>
                        <p className="text-slate-500 mb-6 text-sm">{msg}</p>
                        <div className="flex justify-end gap-2">
                            <button onClick={onCancel} className="px-4 py-2 rounded text-sm font-bold text-slate-600 bg-slate-100 hover:bg-slate-200">Batal</button>
                            <button onClick={onConfirm} className="px-4 py-2 rounded text-sm font-bold bg-red-600 text-white hover:bg-red-700">Ya</button>
                        </div>
                    </div>
                </div>
            ); 
        }

        function LoginScreen({ onGoogleLogin }) {
          return (
            <div className="min-h-screen flex items-center justify-center bg-[#EEF2FF] p-4 animate-fade-in relative overflow-hidden">
                 {/* Vector Blob Backgrounds */}
                 <div className="absolute top-[-10%] left-[-10%] w-[500px] h-[500px] bg-purple-200 rounded-full mix-blend-multiply filter blur-3xl opacity-50 animate-blob"></div>
                 <div className="absolute top-[-10%] right-[-10%] w-[500px] h-[500px] bg-yellow-200 rounded-full mix-blend-multiply filter blur-3xl opacity-50 animate-blob animation-delay-2000"></div>
                 <div className="absolute bottom-[-20%] left-[20%] w-[500px] h-[500px] bg-pink-200 rounded-full mix-blend-multiply filter blur-3xl opacity-50 animate-blob animation-delay-4000"></div>

                 <div className="max-w-5xl w-full bg-white/80 backdrop-blur-xl rounded-[2rem] shadow-2xl border border-white flex flex-col md:flex-row relative z-10 overflow-hidden">
                    
                    {/* Left Side: Vector Illustration Area */}
                    <div className="w-full md:w-1/2 bg-indigo-600 p-12 flex flex-col justify-between text-white relative overflow-hidden">
                        {/* Abstract Patterns */}
                        <div className="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full blur-2xl transform translate-x-10 -translate-y-10"></div>
                        <div className="absolute bottom-0 left-0 w-32 h-32 bg-white/10 rounded-full blur-2xl transform -translate-x-10 translate-y-10"></div>
                        
                        <div className="relative z-10">
                            <div className="flex items-center gap-3 mb-6">
                                <div className="p-2 bg-white/20 rounded-lg backdrop-blur-sm">
                                    <BookOpen className="w-6 h-6 text-white"/>
                                </div>
                                <span className="font-bold tracking-wider text-sm opacity-90">SKOLAHUB 2.0</span>
                            </div>
                            <h2 className="text-4xl font-black mb-4 leading-tight">Pengurusan Sekolah <br/>Lebih Efisien.</h2>
                            <p className="text-indigo-100 text-sm leading-relaxed max-w-xs">Sistem berpusat untuk kehadiran, MMI, laporan guru bertugas dan analisis data masa nyata.</p>
                        </div>

                        {/* Illustration Image */}
                        <div className="relative mt-8 flex justify-center">
                            <img 
                                src="https://cdni.iconscout.com/illustration/premium/thumb/online-school-learning-2996025-2491564.png" 
                                className="w-64 drop-shadow-2xl hover:scale-105 transition-transform duration-500"
                                alt="Vector Student"
                                onError={(e) => e.target.style.display = 'none'} // Hide if fails
                            />
                        </div>
                        
                        <div className="mt-8 flex gap-2">
                            <div className="h-1 w-8 bg-white rounded-full"></div>
                            <div className="h-1 w-2 bg-white/30 rounded-full"></div>
                            <div className="h-1 w-2 bg-white/30 rounded-full"></div>
                        </div>
                    </div>

                    {/* Right Side: Login Form */}
                    <div className="w-full md:w-1/2 p-10 md:p-16 flex flex-col justify-center items-center bg-white relative">
                        <div className="w-20 h-20 bg-indigo-50 rounded-2xl flex items-center justify-center mb-6 shadow-sm border border-indigo-100 transform -rotate-3 hover:rotate-0 transition-transform duration-300">
                            <img src="https://i.postimg.cc/k4N1mPR1/semat-04.png" alt="Logo Sekolah" className="w-12 h-12 object-contain"/>
                        </div>
                        
                        <h3 className="text-2xl font-bold text-slate-800 mb-2">Selamat Datang!</h3>
                        <p className="text-slate-400 mb-10 text-center text-sm font-medium">Sila log masuk menggunakan akaun Google Guru / Pentadbir.</p>
                        
                        <button onClick={onGoogleLogin} className="w-full max-w-xs flex items-center justify-center gap-4 p-4 rounded-xl border-2 border-slate-100 bg-white hover:border-indigo-600 hover:bg-indigo-50 transition-all group duration-300 shadow-sm hover:shadow-md transform hover:-translate-y-1">
                            <img src="https://www.svgrepo.com/show/475656/google-color.svg" className="w-6 h-6" alt="Google" />
                            <span className="font-bold text-slate-700 group-hover:text-indigo-700">Log Masuk Google</span>
                        </button>
                        
                        <div className="mt-12 text-center">
                            <p className="text-[10px] text-slate-300 font-bold uppercase tracking-widest mb-2">Dibangunkan Oleh</p>
                            <div className="flex items-center justify-center gap-2 opacity-60 grayscale hover:grayscale-0 transition-all cursor-default">
                                <span className="text-xs font-bold text-slate-500">Unit ICT SK Masjid Tanah</span>
                            </div>
                        </div>
                    </div>
                 </div>
            </div>
          );
        }

        // --- 2. LAYOUT COMPONENTS (SIDEBAR & RESPONSIVE LOGIC) ---

        function Sidebar({ userData, view, setView, logout }) {
          const menus = [
             { id: 'dashboard', l: 'Utama', i: LayoutDashboard },
             { id: 'mmi', l: 'MMI', i: QrCode }, 
             { id: 'timetable', l: 'Jadual Waktu', i: CalendarClock }, 
             { id: 'apps', l: 'Aplikasi', i: MonitorPlay },
             { id: 'takwim', l: 'Takwim', i: CalendarDays },
             { id: 'attendance', l: 'Kehadiran', i: UserCheck },
             { id: 'tasks', l: 'Tugasan', i: ClipboardList },
             { id: 'reports', l: 'Laporan', i: FileText },
             { id: 'agihan', l: 'Agihan Tugas', i: Briefcase, access: ['admin', 'pentadbir'] },
             { id: 'builder', l: 'Bina App', i: Code2, access: ['admin'] },
             { id: 'students', l: 'Data Murid', i: GraduationCap, access: ['admin', 'pentadbir'] },
             { id: 'teachers', l: 'Data Guru', i: Users, access: ['admin', 'pentadbir'] },
          ];
          
          const adminMenus = [
              { id: 'logs', l: 'Log Sistem', i: Activity, access: ['admin'] },
              { id: 'stats', l: 'Statistik', i: BarChart3, access: ['admin'] }
          ];

          // --- LOGIK INSTALL PWA ---
          const [deferredPrompt, setDeferredPrompt] = useState(null);
          useEffect(() => {
             const handler = (e) => {
                 e.preventDefault();
                 setDeferredPrompt(e);
             };
             window.addEventListener('beforeinstallprompt', handler);
             return () => window.removeEventListener('beforeinstallprompt', handler);
          }, []);

          const handleInstall = async () => {
             if (!deferredPrompt) {
                 alert("Fungsi pemasangan (Install) hanya aktif di pelayar sebenar (Chrome/Edge/Safari).\n\nDalam mod preview ini, acara 'beforeinstallprompt' tidak dicetuskan oleh pelayar.");
                 return;
             }
             deferredPrompt.prompt();
             const { outcome } = await deferredPrompt.userChoice;
             setDeferredPrompt(null);
          };
          
          return (
             <aside className="w-full md:w-64 bg-white border-t md:border-t-0 md:border-r border-slate-200 flex flex-row md:flex-col shrink-0 z-50 no-print transition-all duration-300 h-16 md:h-full md:relative">
                {/* Desktop Logo (Kiri Atas bila di Desktop) */}
                <div className="hidden md:flex h-20 items-center justify-center md:justify-start md:px-6 border-b border-slate-100 gap-3"><img src="https://i.postimg.cc/k4N1mPR1/semat-04.png" className="w-10 h-10 object-contain"/><div className="hidden md:block"><span className="block font-bold text-lg text-slate-800 leading-tight">SkolaHub</span><span className="block text-[10px] font-bold text-slate-500 uppercase tracking-wide">SK Masjid Tanah</span></div></div>
                
                {/* Mobile Logo (Kiri Bar bila di Phone) */}
                <div className="md:hidden flex items-center justify-center px-4 border-r border-slate-100">
                    <img src="https://i.postimg.cc/k4N1mPR1/semat-04.png" className="w-8 h-8 object-contain"/>
                </div>

                {/* Profile Block (Desktop Only - dibawah logo) */}
                <div className="hidden md:flex p-4 border-b border-slate-100 items-center gap-3 relative group-user">
                   <img src={userData.photo || "https://ui-avatars.com/api/?name="+userData.name} className="w-10 h-10 rounded-full border border-slate-200"/><div className="hidden md:block overflow-hidden"><p className="text-sm font-bold text-slate-700 truncate">{userData.name}</p><p className="text-xs text-slate-500 uppercase font-bold tracking-wider">{userData.role}</p></div>
                </div>
                
                {/* Navigation Menu (Horizontal Scroll di Phone, Vertical Stack di Desktop) */}
                <nav className="flex-1 flex flex-row md:flex-col items-center md:items-stretch overflow-x-auto md:overflow-y-auto p-2 md:p-4 gap-2 md:space-y-1 no-scrollbar">
                    {menus.map(m => (!m.access || m.access.includes(userData.role)) && <button key={m.id} onClick={() => setView(m.id)} title={m.l} className={`flex-shrink-0 flex items-center justify-center md:justify-start gap-3 px-3 py-2 rounded-lg text-sm font-medium transition-all ${view === m.id ? 'bg-indigo-50 text-indigo-700 shadow-sm border border-indigo-100' : 'text-slate-500 hover:bg-slate-50 border border-transparent'}`}><m.i className={`w-5 h-5 ${view === m.id ? 'text-indigo-600' : 'text-slate-400'}`} /><span className="hidden md:block">{m.l}</span></button>)}
                    
                    {userData.role === 'admin' && (
                        <>
                            <div className="hidden md:block my-2 border-t border-slate-100 mx-2"></div>
                            {adminMenus.map(m => <button key={m.id} onClick={() => setView(m.id)} title={m.l} className={`flex-shrink-0 flex items-center justify-center md:justify-start gap-3 px-3 py-2 rounded-lg text-sm font-medium transition-all ${view === m.id ? 'bg-indigo-50 text-indigo-700 shadow-sm border border-indigo-100' : 'text-slate-500 hover:bg-slate-50 border border-transparent'}`}><m.i className={`w-5 h-5 ${view === m.id ? 'text-indigo-600' : 'text-slate-400'}`} /><span className="hidden md:block">{m.l}</span></button>)}
                        </>
                    )}
                </nav>
                
                {/* Bottom Actions (Desktop Only - Install & Logout) */}
                <div className="hidden md:block p-4 border-t border-slate-100 space-y-2">
                    <button onClick={handleInstall} className="flex items-center justify-center md:justify-start gap-3 text-emerald-600 hover:bg-emerald-50 text-sm font-bold w-full px-3 py-3 rounded-lg transition-colors border border-emerald-100">
                        <Download className="w-5 h-5" />
                        <span className="hidden md:block">Pasang Aplikasi</span>
                    </button>
                    <button onClick={logout} className="flex items-center justify-center md:justify-start gap-3 text-slate-400 hover:text-red-600 hover:bg-red-50 text-sm font-medium w-full px-3 py-3 rounded-lg transition-colors"><LogOut className="w-5 h-5" /><span className="hidden md:block">Keluar</span></button>
                </div>

                {/* Mobile Actions (Icons Only - Kanan Bar) */}
                <div className="md:hidden flex items-center pr-2 border-l border-slate-100 pl-2 gap-1">
                    <button onClick={handleInstall} className="p-2 text-emerald-600 rounded-full hover:bg-emerald-50"><Download className="w-5 h-5"/></button>
                    <button onClick={logout} className="p-2 text-red-500 rounded-full hover:bg-red-50"><LogOut className="w-5 h-5"/></button>
                </div>
             </aside>
          )
        }

        function Header({ userData, view }) {
           const titles = { mmi: "MMI", timetable: "Jadual Waktu Peribadi", logs: "Log Sistem", stats: "Statistik Penggunaan" };
           
           return (
              <header className="h-14 md:h-16 bg-white border-b border-slate-200 px-4 md:px-6 flex items-center justify-between shrink-0 shadow-sm z-10 no-print">
                 <h2 className="font-bold text-base md:text-lg capitalize text-slate-800 flex items-center gap-2">{titles[view] || view}</h2>
                 <div className="flex items-center gap-3">
                     <span className="text-[10px] md:text-xs font-bold uppercase text-white bg-indigo-600 px-2 md:px-3 py-1 rounded-full tracking-wider shadow-sm">{userData.role}</span>
                 </div>
              </header>
           )
        }

        // --- 3. FEATURE COMPONENTS ---
        
        function SystemLogs() {
            const [logs, setLogs] = useState([]);
            useEffect(() => { const q = query(collection(db, 'portal_access_logs'), orderBy('timestamp', 'desc'), limit(50)); const unsub = onSnapshot(q, (snap) => { setLogs(snap.docs.map(d => ({id: d.id, ...d.data()}))); }); return () => unsub(); }, []);
            return (
                <div className="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                    <div className="overflow-x-auto">
                        <table className="w-full text-sm text-left">
                            <thead className="bg-slate-50 text-slate-500 font-bold uppercase text-xs">
                                <tr>
                                    <th className="p-4 border-b">Nama Guru</th>
                                    <th className="p-4 border-b">E-mel</th>
                                    <th className="p-4 border-b">Peranan</th>
                                    <th className="p-4 border-b text-right">Waktu Log Masuk</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-100">
                                {logs.map(log => (
                                    <tr key={log.id} className="hover:bg-slate-50">
                                        <td className="p-4 font-bold text-slate-700">{log.name}</td>
                                        <td className="p-4 text-slate-500">{log.email}</td>
                                        <td className="p-4"><span className="uppercase text-[10px] bg-slate-100 px-2 py-1 rounded font-bold">{log.role}</span></td>
                                        <td className="p-4 text-right font-mono text-xs text-slate-500">
                                            {formatDate(log.timestamp)} {new Date(log.timestamp).toLocaleTimeString('ms-MY')}
                                        </td>
                                    </tr>
                                ))}
                                {logs.length === 0 && <tr><td colSpan="4" className="p-8 text-center text-slate-400 italic">Tiada rekod log masuk.</td></tr>}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }
        
        function UsageStats() {
            const [stats, setStats] = useState({ logs: 0, mmi: 0, reports: 0 });
            useEffect(() => { 
                const unsub1 = onSnapshot(collection(db, 'portal_access_logs'), s => setStats(p => ({...p, logs: s.size}))); 
                const unsub2 = onSnapshot(collection(db, 'portal_mmi'), s => setStats(p => ({...p, mmi: s.size}))); 
                const unsub3 = onSnapshot(collection(db, 'portal_reports'), s => setStats(p => ({...p, reports: s.size}))); 
                return () => { unsub1(); unsub2(); unsub3(); }; 
            }, []);
            
            return (
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex items-center gap-4">
                        <div className="w-12 h-12 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center"><Activity/></div>
                        <div><p className="text-sm text-slate-500 font-bold">Jumlah Log Masuk</p><h3 className="text-2xl font-bold">{stats.logs}</h3></div>
                    </div>
                    <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex items-center gap-4">
                        <div className="w-12 h-12 bg-indigo-50 text-indigo-600 rounded-full flex items-center justify-center"><QrCode/></div>
                        <div><p className="text-sm text-slate-500 font-bold">Rekod MMI</p><h3 className="text-2xl font-bold">{stats.mmi}</h3></div>
                    </div>
                    <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex items-center gap-4">
                        <div className="w-12 h-12 bg-emerald-50 text-emerald-600 rounded-full flex items-center justify-center"><FileText/></div>
                        <div><p className="text-sm text-slate-500 font-bold">Laporan Harian</p><h3 className="text-2xl font-bold">{stats.reports}</h3></div>
                    </div>
                </div>
            );
        }

        function MMIManager({ userData, currentUid, students, teachers }) {
            const [logs, setLogs] = useState([]);
            const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
            const [loading, setLoading] = useState(true);
            const [showScan, setShowScan] = useState(false);
            const [timetable, setTimetable] = useState({});
            const videoRef = useRef(null);
            const canvasRef = useRef(null);
            const reqRef = useRef(null);
            const [cameraActive, setCameraActive] = useState(false);
            const [selectedTeacherId, setSelectedTeacherId] = useState("");
            const isAdminOrPentadbir = ['admin', 'pentadbir'].includes(userData.role);
            const [showSlotSelection, setShowSlotSelection] = useState(false);
            const [detectedClass, setDetectedClass] = useState("");
            const [availableSlots, setAvailableSlots] = useState([]);
            const [manualWeek, setManualWeek] = useState("");
            const [selectedIds, setSelectedIds] = useState([]);
            const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
            const [expandedWeeks, setExpandedWeeks] = useState({});
            const [isDownloading, setIsDownloading] = useState(false);
            
            const getDay = (d) => { const days = ['Ahad','Isnin','Selasa','Rabu','Khamis','Jumaat','Sabtu']; return days[new Date(d).getDay()]; };
            const dayName = getDay(date);
            
            // LOGIC TARGET UID DIKEMASKINI: 
            // Ambil UID sebenar daripada senarai teachers jika ada selection.
            const selectedTeacher = teachers.find(t => t.id === selectedTeacherId);
            const targetUid = selectedTeacher ? (selectedTeacher.uid || "no_data") : currentUid;

            useEffect(() => {
                const q = query(collection(db, 'portal_mmi'), where('createdBy', '==', targetUid), orderBy('date', 'desc'));
                const unsub = onSnapshot(q, s => { setLogs(s.docs.map(d => ({id:d.id, ...d.data()}))); setLoading(false); });
                getDoc(doc(db, 'portal_timetables', targetUid)).then(snap => { if (snap.exists()) setTimetable(snap.data().schedule || {}); else setTimetable({}); });
                return () => unsub();
            }, [targetUid]);

            const groupedLogs = useMemo(() => { return logs.reduce((acc, log) => { const w = log.week || 'Tiada Minggu'; if (!acc[w]) acc[w] = []; acc[w].push(log); return acc; }, {}); }, [logs]);
            const sortedWeeks = Object.keys(groupedLogs).sort((a, b) => { return parseInt(b) || 0 - parseInt(a) || 0; });
            
            const scanTick = () => {
                if (videoRef.current && videoRef.current.readyState === videoRef.current.HAVE_ENOUGH_DATA) {
                    const video = videoRef.current;
                    const canvas = canvasRef.current;
                    if (canvas) {
                        canvas.height = video.videoHeight;
                        canvas.width = video.videoWidth;
                        const ctx = canvas.getContext("2d");
                        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        
                        if (window.jsQR) {
                            const code = window.jsQR(imageData.data, imageData.width, imageData.height, {
                                inversionAttempts: "dontInvert",
                            });
                            if (code && code.data) {
                                handleScan(code.data);
                                return;
                            }
                        }
                    }
                }
                reqRef.current = requestAnimationFrame(scanTick);
            };

            const startCamera = async () => { 
                setShowScan(true); 
                setCameraActive(true); 
                try { 
                    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }); 
                    if (videoRef.current) { 
                        videoRef.current.srcObject = stream; 
                        videoRef.current.setAttribute("playsinline", true);
                        await videoRef.current.play();
                        reqRef.current = requestAnimationFrame(scanTick);
                    } 
                } catch (err) { console.error("Camera error:", err); alert("Gagal buka kamera: " + err.message); } 
            };

            const stopCamera = () => { 
                if (videoRef.current && videoRef.current.srcObject) { 
                    videoRef.current.srcObject.getTracks().forEach(track => track.stop()); 
                } 
                if (reqRef.current) cancelAnimationFrame(reqRef.current);
                setCameraActive(false); 
                setShowScan(false); 
            };
            
            const handleScan = (cls) => { 
                setDetectedClass(cls); 
                stopCamera(); 
                const daySchedule = timetable[dayName] || {}; 
                const slots = []; 
                Object.entries(daySchedule).forEach(([time, data]) => { if (data.class && data.class.includes(cls)) { slots.push({ time, subject: data.subject, class: data.class }); } }); 
                setAvailableSlots(slots); 
                setShowSlotSelection(true); 
            };
            
            const confirmSlot = (slot) => { 
                if (!manualWeek) return alert("Sila masukkan nombor minggu."); 
                saveMMI(slot.class, slot.time, slot.subject, manualWeek); 
                setShowSlotSelection(false); 
            };
            
            const saveMMI = async (cls, time, subject, weekVal) => { 
                await addDoc(collection(db, 'portal_mmi'), { date, day: dayName, class: cls, time: time, subject: subject, week: weekVal, teacher: userData.name, createdBy: currentUid, timestamp: new Date().toISOString() }); 
                alert(`MMI Direkod: ${cls} - ${subject} (${time})`); 
            };
            
            const copyWeekToNext = async (weekNum, logsInWeek) => { 
                if (!confirm(`Salin semua rekod Minggu ${weekNum} ke minggu hadapan?`)) return; 
                const batch = writeBatch(db); 
                const nextWeekNum = String(parseInt(weekNum) + 1); 
                logsInWeek.forEach(log => { 
                    const nextWeekDate = new Date(log.date); 
                    nextWeekDate.setDate(nextWeekDate.getDate() + 7); 
                    const nextDateStr = nextWeekDate.toISOString().split('T')[0]; 
                    const newRef = doc(collection(db, 'portal_mmi')); 
                    const { id, ...logData } = log; 
                    batch.set(newRef, { ...logData, date: nextDateStr, day: getDay(nextDateStr), week: nextWeekNum, timestamp: new Date().toISOString() }); 
                }); 
                await batch.commit(); 
                alert(`Berjaya disalin ke Minggu ${nextWeekNum}`); 
            };
            
            const toggleSelectLog = (id) => { setSelectedIds(prev => prev.includes(id) ? prev.filter(x => x !== id) : [...prev, id]); };
            const deleteSelectedLogs = async () => { const batch = writeBatch(db); selectedIds.forEach(id => { batch.delete(doc(db, 'portal_mmi', id)); }); await batch.commit(); setSelectedIds([]); setShowDeleteConfirm(false); };
            const classList = [...new Set(students.map(s => s.class))].sort();

            // Auto Date to Day
            const handleDateChange = (e) => {
                const val = e.target.value;
                setDate(val);
            };

            // --- FUNGSI MUAT TURUN EXCEL (CSV) UNTUK PENTADBIR (KECUALI ADMIN) ---
            const downloadAllMMI = async () => {
                if (!confirm("Muat turun laporan Excel MMI untuk SEMUA guru & Pentadbir (kecuali Admin)?")) return;
                setIsDownloading(true);
                try {
                    // 1. Dapatkan SEMUA data MMI
                    const q = query(collection(db, 'portal_mmi'), orderBy('date', 'desc'));
                    const snapshot = await getDocs(q);
                    const allLogs = snapshot.docs.map(d => d.data());

                    // 2. Buat Peta Guru untuk cek Role
                    const teacherMap = {};
                    teachers.forEach(t => {
                        if (t.uid) teacherMap[t.uid] = t;
                    });

                    // 3. Tapis keluar ADMIN
                    const filteredLogs = allLogs.filter(log => {
                        const creator = teacherMap[log.createdBy];
                        // Jika creator wujud dan role dia 'admin', buang
                        if (creator && creator.role === 'admin') return false;
                        // Fallback tambahan jika nama admin hardcoded
                        if (log.teacher === 'Iqbal Muhaider') return false;
                        return true;
                    });

                    // 4. Tukar ke CSV Format
                    const headers = ["Tarikh", "Hari", "Minggu", "Nama Guru", "Kelas", "Masa", "Subjek", "Timestamp"];
                    const csvRows = [headers.join(",")];

                    filteredLogs.forEach(log => {
                        const row = [
                            `"${log.date || ''}"`,
                            `"${log.day || ''}"`,
                            `"${log.week || ''}"`,
                            `"${log.teacher || ''}"`,
                            `"${log.class || ''}"`,
                            `"${log.time || ''}"`,
                            `"${log.subject || ''}"`,
                            `"${log.timestamp || ''}"`
                        ];
                        csvRows.push(row.join(","));
                    });

                    // 5. Muat Turun Fail
                    const blob = new Blob([csvRows.join("\n")], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement("a");
                    link.setAttribute("href", url);
                    link.setAttribute("download", `Laporan_MMI_Keseluruhan_${new Date().toISOString().split('T')[0]}.csv`);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    alert("Berjaya dimuat turun!");

                } catch (error) {
                    console.error("Error downloading MMI:", error);
                    alert("Gagal memuat turun data.");
                } finally {
                    setIsDownloading(false);
                }
            };

            return (
                <div className="max-w-4xl mx-auto space-y-6 animate-fade-in">
                    {isAdminOrPentadbir && (
                        <div className="bg-white p-6 rounded-xl border border-indigo-100 shadow-sm mb-6">
                            <h3 className="font-bold text-slate-800 mb-2 flex items-center gap-2"><Search size={18}/> Semakan MMI Guru</h3>
                            <div className="flex gap-2">
                                <select className="w-full border p-2 rounded-lg" value={selectedTeacherId} onChange={(e) => setSelectedTeacherId(e.target.value)}>
                                    <option value="">-- Paparan Saya (Diri Sendiri) --</option>
                                    {teachers.map(t => <option key={t.id} value={t.id}>{t.name} {t.uid ? "" : "(Belum Login)"}</option>)}
                                </select>
                                <button onClick={downloadAllMMI} disabled={isDownloading} className="bg-emerald-600 text-white px-4 py-2 rounded-lg font-bold shadow-sm hover:bg-emerald-700 flex items-center gap-2 whitespace-nowrap disabled:bg-slate-400">
                                    {isDownloading ? <Loader2 className="w-4 h-4 animate-spin"/> : <FileSpreadsheet className="w-4 h-4"/>} Excel
                                </button>
                            </div>
                            <p className="text-[10px] text-slate-400 mt-1 italic">*Muat turun Excel merangkumi semua guru & pentadbir (kecuali Admin).</p>
                        </div>
                    )}
                    
                    <div className="bg-white p-6 rounded-xl border shadow-sm">
                        {/* Paparan Scan hanya muncul jika sedang lihat diri sendiri (targetUid == currentUid) */}
                        {(targetUid === currentUid) && (<div className="flex justify-between items-center mb-6"><div><label className="text-xs font-bold text-slate-500 uppercase block">Tarikh (Boleh Backdated)</label><input type="date" className="font-bold text-lg outline-none bg-transparent" value={date} onChange={handleDateChange} /><span className="text-sm text-slate-500 ml-2">({dayName})</span></div><button onClick={startCamera} className="bg-indigo-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg hover:bg-indigo-700 flex items-center gap-2 transition-transform hover:scale-105"><QrCode className="w-6 h-6"/> Scan QR Kelas</button></div>)}
                        
                        <div className="flex justify-between items-center mb-4 border-b pb-2"><h3 className="font-bold text-slate-700">Sejarah MMI {targetUid !== currentUid ? `(${teachers.find(t=>t.id===selectedTeacherId)?.name})` : '(Saya)'}</h3>{selectedIds.length > 0 && (<button onClick={()=>setShowDeleteConfirm(true)} className="bg-red-50 text-red-600 px-3 py-1 rounded text-xs font-bold border border-red-200 hover:bg-red-100 flex items-center gap-1"><Trash2 size={14}/> Padam ({selectedIds.length})</button>)}</div>
                        <div className="space-y-4">{logs.length === 0 ? <p className="text-slate-400 italic text-center py-4">Tiada rekod MMI.</p> : sortedWeeks.map(weekNum => { const weekLogs = groupedLogs[weekNum]; const isOpen = expandedWeeks[weekNum]; return (<div key={weekNum} className="bg-white border rounded-xl shadow-sm overflow-hidden"><div className={`p-4 flex justify-between items-center bg-slate-50 cursor-pointer ${isOpen ? 'border-b border-indigo-100' : ''}`} onClick={() => setExpandedWeeks(p => ({...p, [weekNum]: !p[weekNum]}))}><div className="flex items-center gap-3"><span className="font-bold text-slate-700">Minggu {weekNum}</span><span className="text-xs bg-slate-200 px-2 py-0.5 rounded-full text-slate-600">{weekLogs.length} Rekod</span></div><div className="flex items-center gap-2">{(targetUid === currentUid) && (<button onClick={(e) => { e.stopPropagation(); copyWeekToNext(weekNum, weekLogs); }} className="text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded border border-blue-200 hover:bg-blue-100 flex items-center gap-1"><Copy size={12}/> Salin Minggu Depan</button>)}<ChevronDown className={`w-4 h-4 text-slate-400 transition-transform ${isOpen ? 'rotate-180' : ''}`}/></div></div>{isOpen && (<div className="divide-y divide-slate-100">{weekLogs.map(log => (<div key={log.id} className="p-3 flex items-center hover:bg-white transition-colors"><div className="mr-3"><input type="checkbox" checked={selectedIds.includes(log.id)} onChange={() => toggleSelectLog(log.id)} className="w-4 h-4 text-indigo-600 rounded"/></div><div className="flex-1"><div className="flex justify-between"><span className="font-bold text-indigo-700 text-sm">{log.class}</span><span className="text-xs text-slate-500 font-mono">{formatDate(log.date)} ({log.day})</span></div><div className="flex justify-between mt-1"><span className="text-xs text-slate-600">{log.subject}</span><span className="text-xs bg-slate-100 px-2 py-0.5 rounded text-slate-500">{log.time}</span></div></div></div>))}</div>)}</div>)})}</div>
                    </div>

                    {showScan && (<div className="fixed inset-0 bg-black/90 flex items-center justify-center z-50 animate-fade-in"><div className="w-full max-w-md bg-white rounded-2xl overflow-hidden relative"><button onClick={stopCamera} className="absolute top-4 right-4 text-white z-10 bg-black/50 rounded-full p-2"><X/></button><div className="relative bg-black h-64 flex items-center justify-center"><video ref={videoRef} className="absolute inset-0 w-full h-full object-cover"></video><canvas ref={canvasRef} className="hidden"></canvas><div className="border-2 border-white/50 w-48 h-48 rounded-lg relative z-10"></div><p className="absolute bottom-4 text-white text-xs bg-black/50 px-2 py-1 rounded">Halakan kamera pada QR Code Kelas</p></div><div className="p-6"><h3 className="font-bold text-lg mb-2 text-center">Atau Pilih Kelas (Simulasi)</h3><div className="grid grid-cols-3 gap-2 max-h-40 overflow-y-auto">{classList.map(c => (<button key={c} onClick={()=>handleScan(c)} className="bg-slate-100 text-slate-700 py-2 rounded font-bold text-xs hover:bg-indigo-100 hover:text-indigo-700 transition-colors">{c}</button>))}</div></div></div></div>)}
                    {showSlotSelection && (<div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 animate-fade-in"><div className="bg-white p-6 rounded-xl w-96 shadow-2xl"><h3 className="font-bold text-lg mb-1 text-slate-800">Sahkan Keberadaan</h3><p className="text-sm text-slate-500 mb-4">Kelas: <b>{detectedClass}</b> pada <b>{dayName}</b></p><div className="mb-4"><label className="text-xs font-bold uppercase text-slate-500 block mb-1">Minggu Pengajaran</label><input autoFocus className="w-full border p-2 rounded text-sm font-bold" placeholder="Contoh: 1, 2, 3..." value={manualWeek} onChange={e=>setManualWeek(e.target.value)} /></div><div className="space-y-2 mb-4"><p className="text-xs font-bold text-slate-400 uppercase">Pilih Slot Masa:</p>{availableSlots.length > 0 ? availableSlots.map((slot, idx) => (<button key={idx} onClick={() => confirmSlot(slot)} className="w-full text-left p-3 border rounded-lg hover:bg-indigo-50 hover:border-indigo-300 transition-all group"><div className="font-bold text-indigo-700 text-sm">{slot.subject}</div><div className="text-xs text-slate-500">{slot.time}</div></button>)) : (<div className="text-center p-4 border border-dashed rounded text-slate-400 text-sm">Tiada jadual untuk kelas ini pada hari ini.<br/><button onClick={() => { saveMMI(detectedClass, "Lain-lain", "Relief/Ganti", manualWeek); setShowSlotSelection(false); }} className="text-indigo-600 underline mt-2 font-bold">Rekod sebagai Relief/Ganti</button></div>)}</div><button onClick={() => setShowSlotSelection(false)} className="w-full text-slate-500 py-2 text-sm font-bold">Batal</button></div></div>)}
                    {showDeleteConfirm && (<div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 animate-fade-in"><div className="bg-white p-6 rounded-xl w-80 shadow-2xl"><h3 className="font-bold text-lg mb-2 text-red-600">Padam Rekod MMI?</h3><p className="text-slate-600 mb-4 text-sm">Anda pasti mahu memadam {selectedIds.length} rekod yang dipilih?</p><div className="flex justify-end gap-2"><button onClick={() => setShowDeleteConfirm(false)} className="px-4 py-2 rounded text-sm font-bold text-slate-600 bg-slate-100 hover:bg-slate-200">Batal</button><button onClick={deleteSelectedLogs} className="px-4 py-2 rounded text-sm font-bold bg-red-600 text-white hover:bg-red-700">Ya, Padam</button></div></div></div>)}
                </div>
            );
        }

        function TimetableManager({ userData, currentUid, students, teachers }) {
           const [schedule, setSchedule] = useState({});
           const [loading, setLoading] = useState(true);
           const [selectedSlots, setSelectedSlots] = useState([]);
           const [showModal, setShowModal] = useState(false);
           const [showDeleteConfirm, setShowDeleteConfirm] = useState(false); 
           const [formData, setFormData] = useState({ subject: '', class: '' });
           
           const [selectedTeacherId, setSelectedTeacherId] = useState("");
           const isAdminOrPentadbir = ['admin', 'pentadbir'].includes(userData.role);
           
           // LOGIC TARGET UID DIKEMASKINI:
           // Ambil UID sebenar daripada senarai teachers jika ada selection.
           const selectedTeacher = teachers.find(t => t.id === selectedTeacherId);
           const targetUid = selectedTeacher ? (selectedTeacher.uid || "no_data") : currentUid;

           const days = ['Isnin', 'Selasa', 'Rabu', 'Khamis', 'Jumaat'];
           const times = ["7:40 - 8:10", "8:10 - 8:40", "8:40 - 9:10", "9:10 - 9:40", "9:40 - 10:10", "10:10 - 10:30 (REHAT)", "10:30 - 11:00", "11:00 - 11:30", "11:30 - 12:00", "12:00 - 12:30", "12:30 - 1:00", "1:00 - 1:30"];
           const classList = useMemo(() => { if (!students || students.length === 0) return []; return [...new Set(students.map(s => s.class))].sort(); }, [students]);

           useEffect(() => {
              setLoading(true);
              const unsub = onSnapshot(doc(db, 'portal_timetables', targetUid), (docSnap) => {
                 if (docSnap.exists()) { setSchedule(docSnap.data().schedule || {}); } else { setSchedule({}); }
                 setLoading(false);
              });
              return () => unsub();
           }, [targetUid]);

           const toggleSlot = (day, time) => {
               // Hanya benarkan edit jika sedang melihat jadual sendiri (targetUid == currentUid)
               if (targetUid !== currentUid) return; 

               if (time.includes("REHAT")) return;
               const slotId = `${day}|${time}`;
               setSelectedSlots(prev => { if (prev.includes(slotId)) return prev.filter(id => id !== slotId); return [...prev, slotId]; });
           };

           const saveBatch = async () => {
               if (selectedSlots.length === 0) return alert("Sila pilih slot.");
               const newSchedule = { ...schedule };
               selectedSlots.forEach(slotId => { const [d, t] = slotId.split('|'); if (!newSchedule[d]) newSchedule[d] = {}; newSchedule[d][t] = formData; });
               try { await setDoc(doc(db, 'portal_timetables', targetUid), { schedule: newSchedule, teacherName: userData.name, updatedAt: new Date().toISOString() }); setSelectedSlots([]); setShowModal(false); alert("Berjaya!"); } catch(e) { alert("Ralat: " + e.message); }
           };
           
           const confirmDelete = () => { if (selectedSlots.length === 0) return alert("Pilih slot untuk dipadam."); setShowDeleteConfirm(true); };
           const clearSlots = async () => {
               const newSchedule = { ...schedule };
               selectedSlots.forEach(slotId => { const [d, t] = slotId.split('|'); if (newSchedule[d]) delete newSchedule[d][t]; });
               await setDoc(doc(db, 'portal_timetables', targetUid), { schedule: newSchedule, teacherName: userData.name, updatedAt: new Date().toISOString() });
               setSelectedSlots([]); setShowDeleteConfirm(false);
           };

           if (loading) return <div className="flex justify-center p-12"><Loader2 className="animate-spin text-slate-400 w-8 h-8"/></div>;

           return (
              <div className="max-w-full mx-auto space-y-6">
                 {isAdminOrPentadbir && (<div className="bg-white p-6 rounded-xl border border-indigo-100 shadow-sm no-print"><h3 className="font-bold text-slate-800 mb-2 flex items-center gap-2"><Search size={18}/> Semakan Jadual Guru</h3><select className="w-full border p-2 rounded-lg" value={selectedTeacherId} onChange={(e) => setSelectedTeacherId(e.target.value)}><option value="">-- Paparan Saya (Diri Sendiri) --</option>{teachers.map(t => <option key={t.id} value={t.id}>{t.name} {t.uid ? "" : "(Belum Login)"}</option>)}</select></div>)}
                 
                 <div className="flex justify-between items-center no-print"><h2 className="text-2xl font-bold text-slate-800 flex items-center gap-2"><CalendarClock className="w-6 h-6 text-indigo-600"/> Jadual Waktu {targetUid !== currentUid ? `(${teachers.find(t=>t.id===selectedTeacherId)?.name})` : 'Peribadi'}</h2><div className="flex gap-2"><button onClick={() => window.print()} className="bg-slate-100 text-slate-700 px-4 py-2 rounded-lg font-bold hover:bg-slate-200 flex items-center gap-2"><Printer className="w-4 h-4"/> Cetak</button></div></div>
                 
                 {targetUid === "no_data" ? (
                    <div className="p-8 text-center border-2 border-dashed border-red-200 bg-red-50 rounded-xl text-red-500 font-bold">Guru ini belum mendaftar masuk ke dalam sistem (Tiada UID).</div>
                 ) : (
                 <div className="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden print-container select-none"><div className="overflow-x-auto"><table className="w-full text-sm border-collapse"><thead><tr className="bg-slate-800 text-white"><th className="p-3 border border-slate-700 min-w-[100px]">Hari / Masa</th>{times.map(t => (<th key={t} className={`p-3 border border-slate-700 text-center whitespace-nowrap text-xs ${t.includes('REHAT') ? 'bg-amber-600' : ''}`}>{t}</th>))}</tr></thead><tbody>{days.map(day => (<tr key={day} className="hover:bg-slate-50"><td className="p-3 border border-slate-200 font-bold bg-slate-100 text-slate-700 text-center">{day}</td>{times.map(time => { const isRehat = time.includes('REHAT'); const slotId = `${day}|${time}`; const isSelected = selectedSlots.includes(slotId); const data = schedule[day]?.[time] || { subject: '', class: '' }; if (isRehat) return <td key={time} className="p-1 border border-slate-200 bg-amber-50 text-center font-bold text-amber-700 text-xs diagonal-stripe">REHAT</td>; return (<td key={time} onClick={() => toggleSlot(day, time)} className={`p-1 border border-slate-200 min-w-[100px] h-16 cursor-pointer transition-all text-center relative ${isSelected ? 'bg-indigo-100 ring-2 ring-inset ring-indigo-500' : ''}`}>{data.subject ? (<div className="flex flex-col justify-center h-full"><span className="font-bold text-slate-800 text-xs">{data.subject}</span><span className="text-[10px] text-slate-500">{data.class}</span></div>) : (<span className="text-slate-300 text-[10px]">-</span>)}{isSelected && <div className="absolute top-1 right-1 w-2 h-2 bg-indigo-600 rounded-full"></div>}</td>) })}</tr>))}</tbody></table></div></div>
                 )}
                 
                 {selectedSlots.length > 0 && (<div className="fixed bottom-6 right-6 z-50 animate-fade-in no-print flex gap-2"><button onClick={confirmDelete} className="bg-red-500 text-white px-4 py-3 rounded-full font-bold shadow-xl hover:bg-red-600 flex items-center gap-2"><Trash2 className="w-5 h-5"/> Padam</button><button onClick={() => { setFormData({subject:'', class:''}); setShowModal(true); }} className="bg-indigo-600 text-white px-6 py-3 rounded-full font-bold shadow-xl hover:bg-indigo-700 flex items-center gap-3 transition-transform hover:scale-105"><Edit3 className="w-5 h-5"/> Isi {selectedSlots.length} Slot</button></div>)}
                 
                 {showModal && (<div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 animate-fade-in no-print"><div className="bg-white p-6 rounded-xl w-80 shadow-2xl"><h3 className="font-bold text-lg mb-4 text-slate-800">Kemaskini Slot</h3><div className="space-y-3"><div><label className="lbl">Subjek</label><input className="inp w-full" autoFocus placeholder="Contoh: Matematik" value={formData.subject} onChange={e=>setFormData({...formData, subject: e.target.value})} /></div><div><label className="lbl">Kelas</label><select className="inp w-full" value={formData.class} onChange={e=>setFormData({...formData, class: e.target.value})}><option value="">-- Pilih Kelas --</option>{classList.length > 0 ? classList.map(c => <option key={c} value={c}>{c}</option>) : <option disabled>Tiada data kelas</option>}<option value="Lain-lain">Lain-lain / Manual</option></select>{formData.class === 'Lain-lain' && <input className="inp w-full mt-2" placeholder="Nama Kelas Manual" onChange={e=>setFormData({...formData, class: e.target.value})} />}</div></div><div className="flex justify-end gap-2 mt-6"><button onClick={() => setShowModal(false)} className="px-4 py-2 rounded text-sm font-bold text-slate-500 hover:bg-slate-100">Batal</button><button onClick={saveBatch} className="px-4 py-2 rounded text-sm font-bold bg-indigo-600 text-white hover:bg-indigo-700">Simpan</button></div></div></div>)}
                 {showDeleteConfirm && (<div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 animate-fade-in no-print"><div className="bg-white p-6 rounded-xl w-80 shadow-2xl"><h3 className="font-bold text-lg mb-2 text-red-600">Padam Slot?</h3><p className="text-slate-500 mb-4 text-sm">Anda pasti mahu memadam {selectedSlots.length} slot terpilih?</p><div className="flex justify-end gap-2"><button onClick={() => setShowDeleteConfirm(false)} className="px-4 py-2 rounded text-sm font-bold text-slate-600 bg-slate-100 hover:bg-slate-200">Batal</button><button onClick={clearSlots} className="px-4 py-2 rounded text-sm font-bold bg-red-600 text-white hover:bg-red-700">Ya, Padam</button></div></div></div>)}
              </div>
           );
        }

        function TakwimManager({ canEdit, role, currentUid }) {
            const [date, setDate] = useState(new Date(2026, 0, 1)); const [events, setEvents] = useState([]); const [selectedDate, setSelectedDate] = useState(null); const [newEvent, setNewEvent] = useState({ title: '', unit: '' });
            useEffect(() => { const unsub = onSnapshot(query(collection(db, 'portal_events')), s => { setEvents(s.docs.map(d => ({ id: d.id, ...d.data() }))); }); return () => unsub(); }, []);
            const allEvents = [...KPM_EVENTS, ...events];
            const handleCellClick = (d) => { if (canEdit) { setSelectedDate(d); setNewEvent({ title: '', unit: '' }); } };
            const addEvent = async () => { if(!newEvent.title) return alert("Isi nama program."); await addDoc(collection(db, 'portal_events'), { title: newEvent.title, unit: newEvent.unit, start: selectedDate.toISOString().split('T')[0], end: selectedDate.toISOString().split('T')[0], type: 'event', createdBy: currentUid }); setSelectedDate(null); };
            const deleteEvent = async (id, e) => { e.stopPropagation(); if(confirm("Padam?")) await deleteDoc(doc(db, 'portal_events', id)); }
            const renderMonth = (targetDate) => { const year = targetDate.getFullYear(); const month = targetDate.getMonth(); const daysInMonth = new Date(year, month + 1, 0).getDate(); const firstDay = new Date(year, month, 1).getDay(); const blanks = Array(firstDay).fill(null); const days = Array.from({length: daysInMonth}, (_, i) => i + 1); return (<div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm"><div className="flex justify-between mb-4 items-center"><button onClick={()=>setDate(new Date(year, month-1, 1))}><ChevronLeft/></button><h3 className="font-bold text-lg uppercase text-slate-700">{targetDate.toLocaleDateString('ms-MY', { month: 'long', year: 'numeric' })}</h3><button onClick={()=>setDate(new Date(year, month+1, 1))}><ChevronRight/></button></div><div className="grid grid-cols-7 gap-1 mb-2 text-center text-xs font-bold text-slate-400">{['A','I','S','R','K','J','S'].map(d=><div key={d}>{d}</div>)}</div><div className="grid grid-cols-7 gap-1">{blanks.map((_,i)=><div key={i}></div>)}{days.map(d => { const currentDay = new Date(year, month, d); const dStr = currentDay.toISOString().split('T')[0]; const dailyEvents = allEvents.filter(e => dStr >= e.start && dStr <= (e.end || e.start)); const isSchool = dailyEvents.some(e => e.type === 'school'); const isHoliday = dailyEvents.some(e => e.type === 'holiday'); const bgClass = isSchool ? 'bg-emerald-50' : (isHoliday ? 'bg-yellow-50' : 'bg-white hover:bg-slate-50'); return (<div key={d} onClick={() => handleCellClick(currentDay)} className={`min-h-[80px] border border-slate-100 rounded p-1 text-xs relative cursor-pointer transition-colors ${bgClass}`}><span className={`font-bold block mb-1 ${isSchool ? 'text-emerald-700' : (isHoliday ? 'text-yellow-700' : 'text-slate-700')}`}>{d}</span><div className="space-y-1">{dailyEvents.map((ev, idx) => { if (ev.type === 'school') return null; const isHolidayItem = ev.type === 'holiday'; const canDelete = ev.type === 'event' && (role === 'admin' || ev.createdBy === currentUid); return (<div key={idx} className={`p-1 rounded text-[10px] leading-tight group relative ${isHolidayItem ? 'bg-yellow-100 text-yellow-800' : 'bg-blue-100 text-blue-800'}`}>{ev.title}{canDelete && (<button onClick={(e)=>deleteEvent(ev.id, e)} className="hidden group-hover:block absolute top-0 right-0 bg-red-500 text-white rounded-full p-0.5"><X size={8}/></button>)}</div>) })}</div></div>) })}</div></div>) };
            return (<div className="space-y-6"><div className="flex justify-between items-center"><h3 className="text-xl font-bold text-slate-800 flex items-center gap-2"><CalendarDays className="w-6 h-6 text-indigo-600"/> Takwim Sekolah</h3></div>{renderMonth(date)}<div className="flex gap-4 text-xs font-medium justify-center text-slate-600"><span className="flex items-center gap-2"><div className="w-3 h-3 bg-emerald-50 border border-emerald-200 rounded"></div> Sesi Sekolah</span><span className="flex items-center gap-2"><div className="w-3 h-3 bg-yellow-100 border border-yellow-200 rounded"></div> Cuti</span><span className="flex items-center gap-2"><div className="w-3 h-3 bg-blue-100 border border-blue-200 rounded"></div> Aktiviti</span></div>{selectedDate && (<div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 animate-fade-in"><div className="bg-white p-6 rounded-xl w-80 shadow-2xl"><h3 className="font-bold text-lg mb-4 text-slate-800">Tambah Aktiviti</h3><div className="space-y-3"><div><label className="lbl">Nama Program</label><input autoFocus className="inp w-full" value={newEvent.title} onChange={e=>setNewEvent({...newEvent, title:e.target.value})}/></div><div><label className="lbl">Unit / Panitia</label><input className="inp w-full" value={newEvent.unit} onChange={e=>setNewEvent({...newEvent, unit:e.target.value})}/></div></div><div className="flex justify-end gap-2 mt-6"><button onClick={()=>setSelectedDate(null)} className="px-4 py-2 rounded text-sm font-bold text-slate-500 hover:bg-slate-100">Batal</button><button onClick={addEvent} className="px-4 py-2 rounded text-sm font-bold bg-indigo-600 text-white hover:bg-indigo-700">Simpan</button></div></div></div>)}</div>)
        }

        function TaskManager({ userData, tasks, currentUid }) {
            const isStaff = ['admin', 'pentadbir', 'guru'].includes(userData.role);
            // State dikemaskini untuk field description dan link
            const [form, setForm] = useState({ title: '', description: '', link: '', deadline: '', assignTo: 'Semua Guru' });
            const [customTarget, setCustomTarget] = useState(false);
            const [selectedTask, setSelectedTask] = useState(null); // Untuk paparan detail popup

            const addTask = async () => { 
                if(!form.title || !form.deadline) return alert("Sila isi Tajuk dan Tarikh Akhir."); 
                const assignedByRole = ['admin', 'pentadbir'].includes(userData.role) ? 'Guru Besar' : 'Guru';
                await addDoc(collection(db, 'portal_tasks'), { 
                    ...form, 
                    assignedBy: userData.name, 
                    assignedByRole, 
                    createdAt: new Date().toISOString(), 
                    createdBy: currentUid 
                }); 
                setForm({ title: '', description: '', link: '', deadline: '', assignTo: 'Semua Guru' }); 
                setCustomTarget(false);
                alert("Tugasan dihantar."); 
            };
            
            const deleteTask = async (id, e) => { 
                e.stopPropagation(); // Elak trigger popup bila tekan delete
                if(confirm("Padam tugasan?")) await deleteDoc(doc(db, 'portal_tasks', id)); 
            }
            
            return (
                <div className="grid lg:grid-cols-3 gap-6 h-[calc(100vh-140px)]">
                    {/* LIST SECTION */}
                    <div className="lg:col-span-2 bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden flex flex-col">
                        <div className="p-4 border-b border-slate-100 bg-slate-50 font-bold text-slate-700 flex justify-between items-center">
                            <span>Senarai Tugasan</span>
                            <span className="text-xs font-normal text-slate-500 italic">*Klik kad untuk butiran</span>
                        </div>
                        <div className="flex-1 overflow-y-auto p-4 space-y-3">
                            {tasks.length === 0 ? <p className="text-center text-slate-400 italic mt-10">Tiada tugasan aktif.</p> : tasks.map(task => { 
                                const isGB = task.assignedByRole === 'Guru Besar'; 
                                const canDelete = userData.role === 'admin' || task.createdBy === currentUid; 
                                return (
                                    <div 
                                        key={task.id} 
                                        onClick={() => setSelectedTask(task)}
                                        className={`p-4 rounded-xl border flex justify-between items-start cursor-pointer hover:shadow-md transition-all group ${isGB ? 'bg-indigo-50 border-indigo-100 hover:border-indigo-300' : 'bg-white border-slate-100 hover:border-slate-300'}`}
                                    >
                                        <div className="flex-1">
                                            <div className="flex items-center gap-2 mb-1">
                                                {isGB && <span className="bg-indigo-600 text-white text-[10px] px-2 py-0.5 rounded font-bold uppercase">PENTADBIR</span>}
                                                <span className="text-xs text-slate-500 font-medium bg-white/50 px-2 rounded border border-slate-200">Kepada: {task.assignTo}</span>
                                            </div>
                                            <h4 className="font-bold text-slate-800 text-lg group-hover:text-indigo-700 transition-colors">{task.title}</h4>
                                            {task.description && <p className="text-xs text-slate-500 line-clamp-1 mt-1">{task.description}</p>}
                                            <p className="text-[10px] text-slate-400 mt-2 flex items-center gap-2">
                                                <span>Oleh: {task.assignedBy}</span>  
                                                <span className="font-bold text-slate-600">Due: {formatDate(task.deadline)}</span>
                                                {task.link && <LinkIcon size={10} className="text-blue-500"/>}
                                            </p>
                                        </div>
                                        {canDelete && (
                                            <button 
                                                onClick={(e)=>deleteTask(task.id, e)} 
                                                className="text-slate-300 hover:text-red-500 hover:bg-red-50 p-2 rounded-full transition-colors"
                                                title="Padam Tugasan"
                                            >
                                                <Trash2 className="w-4 h-4"/>
                                            </button>
                                        )}
                                    </div>
                                )
                            })}
                        </div>
                    </div>

                    {/* FORM SECTION */}
                    {isStaff && (
                        <div className="bg-white rounded-xl border border-slate-200 shadow-sm p-6 h-fit overflow-y-auto">
                            <h3 className="font-bold text-slate-800 mb-4 flex items-center gap-2"><Plus className="w-5 h-5 text-indigo-600"/> Tambah Tugasan</h3>
                            <div className="space-y-4">
                                {/* Tajuk - Input Biasa */}
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Tajuk Tugasan</label>
                                    <input 
                                        className="w-full border border-slate-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none" 
                                        value={form.title} 
                                        onChange={e=>setForm({...form, title:e.target.value})} 
                                        placeholder="Contoh: Hantar RPH Minggu 42"
                                    />
                                </div>

                                {/* Deskripsi - Textarea */}
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Deskripsi / Arahan (Pilihan)</label>
                                    <textarea 
                                        className="w-full border border-slate-300 rounded-lg p-2 text-sm h-24 resize-none focus:ring-2 focus:ring-indigo-500 outline-none" 
                                        value={form.description} 
                                        onChange={e=>setForm({...form, description:e.target.value})} 
                                        placeholder="Maklumat lanjut mengenai tugasan..."
                                    />
                                </div>

                                {/* Link - Input */}
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Pautan / Link (Pilihan)</label>
                                    <div className="flex items-center border border-slate-300 rounded-lg overflow-hidden focus-within:ring-2 focus-within:ring-indigo-500">
                                        <div className="bg-slate-50 p-2 border-r border-slate-300"><LinkIcon size={14} className="text-slate-400"/></div>
                                        <input 
                                            className="w-full p-2 text-sm outline-none" 
                                            value={form.link} 
                                            onChange={e=>setForm({...form, link:e.target.value})} 
                                            placeholder="https://..."
                                        />
                                    </div>
                                </div>

                                {/* Tarikh & Sasaran */}
                                <div className="grid grid-cols-2 gap-3">
                                    <div>
                                        <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Tarikh Akhir</label>
                                        <input type="date" className="w-full border border-slate-300 rounded-lg p-2 text-sm font-bold text-slate-700" value={form.deadline} onChange={e=>setForm({...form, deadline:e.target.value})}/>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Sasaran</label>
                                        <select className="w-full border border-slate-300 rounded-lg p-2 text-sm" value={customTarget ? 'manual' : form.assignTo} onChange={e=>{ 
                                            if(e.target.value === 'manual') { setCustomTarget(true); setForm({...form, assignTo: ''}); } 
                                            else { setCustomTarget(false); setForm({...form, assignTo: e.target.value}); } 
                                        }}>
                                            <option>Semua Guru</option>
                                            <option>Pentadbir</option>
                                            <option>Ketua Panitia</option>
                                            <option value="manual">Lain-lain...</option>
                                        </select>
                                    </div>
                                </div>
                                {customTarget && <input className="w-full border border-slate-300 rounded-lg p-2 text-sm" placeholder="Nyatakan sasaran (Contoh: Guru Math)" value={form.assignTo} onChange={e=>setForm({...form, assignTo:e.target.value})} />}
                                
                                <button onClick={addTask} className="w-full bg-indigo-600 text-white py-2.5 rounded-lg font-bold shadow-md hover:bg-indigo-700 transition transform active:scale-95">Hantar Arahan</button>
                            </div>
                        </div>
                    )}

                    {/* DETAIL POPUP MODAL */}
                    {selectedTask && (
                        <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 animate-fade-in backdrop-blur-sm">
                            <div className="bg-white rounded-2xl w-full max-w-lg shadow-2xl flex flex-col max-h-[90vh]">
                                <div className="p-6 border-b border-slate-100 flex justify-between items-start bg-slate-50 rounded-t-2xl">
                                    <div>
                                        <span className="text-[10px] font-bold uppercase tracking-wider text-slate-500 bg-white border px-2 py-1 rounded">Arahan {selectedTask.assignedByRole}</span>
                                        <h3 className="text-xl font-bold text-slate-800 mt-2 leading-tight">{selectedTask.title}</h3>
                                    </div>
                                    <button onClick={() => setSelectedTask(null)} className="text-slate-400 hover:text-red-500 bg-white p-1 rounded-full border hover:bg-red-50 transition-colors"><X size={20}/></button>
                                </div>
                                
                                <div className="p-6 overflow-y-auto space-y-6">
                                    {/* Info Grid */}
                                    <div className="grid grid-cols-2 gap-4 text-sm">
                                        <div className="bg-slate-50 p-3 rounded-lg border border-slate-100">
                                            <span className="block text-xs text-slate-400 uppercase font-bold mb-1">Dihantar Oleh</span>
                                            <span className="font-bold text-slate-700">{selectedTask.assignedBy}</span>
                                        </div>
                                        <div className="bg-slate-50 p-3 rounded-lg border border-slate-100">
                                            <span className="block text-xs text-slate-400 uppercase font-bold mb-1">Tarikh Akhir</span>
                                            <span className={`font-bold ${new Date(selectedTask.deadline) < new Date() ? 'text-red-600' : 'text-emerald-600'}`}>{formatDate(selectedTask.deadline)}</span>
                                        </div>
                                        <div className="bg-slate-50 p-3 rounded-lg border border-slate-100 col-span-2">
                                            <span className="block text-xs text-slate-400 uppercase font-bold mb-1">Kepada</span>
                                            <span className="font-bold text-slate-700">{selectedTask.assignTo}</span>
                                        </div>
                                    </div>

                                    {/* Description */}
                                    {selectedTask.description ? (
                                        <div>
                                            <h4 className="text-sm font-bold text-slate-700 uppercase mb-2 border-b pb-1">Butiran Tugasan</h4>
                                            <p className="text-slate-600 text-sm whitespace-pre-wrap leading-relaxed">{selectedTask.description}</p>
                                        </div>
                                    ) : (
                                        <p className="text-slate-400 italic text-sm text-center">Tiada deskripsi tambahan.</p>
                                    )}

                                    {/* Link Button */}
                                    {selectedTask.link && (
                                        <a 
                                            href={selectedTask.link} 
                                            target="_blank" 
                                            rel="noopener noreferrer"
                                            className="flex items-center justify-center gap-2 w-full bg-blue-50 text-blue-600 border border-blue-200 py-3 rounded-xl font-bold hover:bg-blue-100 transition-colors"
                                        >
                                            <LinkIcon size={18}/> Buka Pautan / Lampiran
                                        </a>
                                    )}
                                </div>

                                <div className="p-4 border-t border-slate-100 bg-slate-50 rounded-b-2xl">
                                    <button onClick={() => setSelectedTask(null)} className="w-full bg-white border border-slate-300 text-slate-600 py-2 rounded-lg font-bold hover:bg-slate-100 text-sm">Tutup</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            )
        }

        function WeeklyReportManager({ userData, reports, teachers, currentUid }) {
            const [mode, setMode] = useState('list'); 
            const [formData, setFormData] = useState(null);
            const [expandedWeeks, setExpandedWeeks] = useState({});
            const [reportToDelete, setReportToDelete] = useState(null);
            const [showSuggestions, setShowSuggestions] = useState(false);
            const [suggestionTab, setSuggestionTab] = useState('perhimpunan');

            const suggestions = {
                perhimpunan: ["Perhimpunan Rasmi Mingguan dijalankan.", "Nyanyian lagu Negaraku, Melaka Maju Jaya & Sekolah.", "Bacaan Doa dan Ikrar Rukun Negara.", "Ucapan Guru Bertugas Mingguan.", "Ucapan Guru Besar / Pentadbir."],
                koku: ["Latihan Rumah Sukan.", "Perjumpaan Unit Beruniform.", "Aktiviti Kelab & Persatuan.", "Pertandingan Bola Sepak MSSM.", "Latihan Kawad Kaki."],
                cuti: ["Cuti Peristiwa sempena Sukan.", "Cuti Berganti.", "Cuti Umum (Hari Raya).", "Cuti Sakit Beramai-ramai (Bencana).", "Sesi Persekolahan berjalan seperti biasa."]
            };
            
            // Helper to get day name
            const getDayFromDate = (dateStr) => {
                const d = new Date(dateStr);
                const days = ['Ahad', 'Isnin', 'Selasa', 'Rabu', 'Khamis', 'Jumaat', 'Sabtu'];
                return days[d.getDay()];
            };

            const todayStr = new Date().toISOString().split('T')[0];

            const initialForm = { 
                week: '', 
                date: todayStr, 
                day: getDayFromDate(todayStr), // AUTO DAY ON INIT
                teachersOnDuty: [{ name: userData.name, note: 'Hadir' }], 
                teachersAbsent: [], activities: '', 
                attendance: { d1: '', d2: '', d3: '', d4: '', d5: '', d6: '', pk: '', pra: '' }, 
                checks: { kantin: { level: 'Baik', comment: '' }, makanan: { level: 'Baik', comment: '' }, sekolah: { level: 'Baik', comment: '' }, tandas: { level: 'Baik', comment: '' } }, 
                health: '', other: '', preparedBy: userData.name, verifiedBy: '', verifiedAt: null 
            };

            const groupedReports = reports.reduce((acc, r) => {
                const w = r.week ? r.week.toString() : 'Lain';
                if (!acc[w]) acc[w] = [];
                acc[w].push(r);
                return acc;
            }, {});

            const sortedWeeks = Object.keys(groupedReports).sort((a, b) => {
                if(a === 'Lain') return 1;
                if(b === 'Lain') return -1;
                return parseInt(b) - parseInt(a);
            });

            const toggleWeek = (weekNum) => {
                setExpandedWeeks(prev => ({...prev, [weekNum]: !prev[weekNum]}));
            };

            const handleAddNew = () => { setFormData(initialForm); setMode('form'); };

            const handleDuplicate = (originalReport) => {
                const { id, createdAt, createdBy, verifiedBy, verifiedAt, verifiedId, ...cleanData } = originalReport;
                const newData = {
                    ...cleanData,
                    date: todayStr,
                    day: getDayFromDate(todayStr),
                    preparedBy: userData.name
                };
                setFormData(newData);
                setMode('form');
                alert("Laporan disalin. Sila kemaskini Tarikh dan Hari sebelum simpan.");
            };

            const handleSave = async () => {
                if(!formData.week || !formData.date) return alert("Sila isi Minggu dan Tarikh.");
                const dataToSave = { ...formData, teachersAbsent: formData.teachersAbsent || [] };
                
                if (formData.id) {
                    await updateDoc(doc(db, 'portal_reports', formData.id), { ...dataToSave, updatedAt: new Date().toISOString() });
                    alert("Laporan dikemaskini.");
                } else {
                    await addDoc(collection(db, 'portal_reports'), { ...dataToSave, createdBy: currentUid, createdAt: new Date().toISOString() });
                    alert("Laporan disimpan!");
                }
                setMode('list');
            };

            const handleVerify = async () => {
                if(confirm("Sahkan laporan ini sebagai Pentadbir?")) {
                    const verifierName = userData.name || userData.email || "Pentadbir";
                    const verifiedData = { verifiedBy: verifierName, verifiedAt: new Date().toISOString(), verifiedId: currentUid };
                    setFormData(prev => ({ ...prev, ...verifiedData }));
                    if (formData.id) {
                        try {
                            await updateDoc(doc(db, 'portal_reports', formData.id), verifiedData);
                            alert("Laporan telah disahkan oleh " + verifierName + ".");
                        } catch (e) {
                            console.error("Ralat pengesahan:", e);
                            alert("Ralat sistem: Gagal mengemaskini status pengesahan.");
                        }
                    } else {
                        alert("Status disahkan. Sila tekan butang 'Simpan Laporan' untuk merekodkan data baru ini.");
                    }
                }
            };

            const requestDelete = (id, ownerId, e) => {
                if(e) e.stopPropagation();
                if(userData.role !== 'admin' && ownerId !== currentUid) return alert("Anda tiada hak memadam laporan ini.");
                setReportToDelete(id);
            };

            const executeDeleteReport = async () => {
                if (reportToDelete) {
                    try {
                        await deleteDoc(doc(db, 'portal_reports', reportToDelete));
                        setReportToDelete(null); 
                    } catch (error) {
                        console.error("Gagal memadam:", error);
                        alert("Ralat semasa memadam laporan.");
                    }
                }
            };

            const handlePrint = () => { window.print(); };
            
            // --- SYNC ATTENDANCE LOGIC (FIXED) ---
            const syncAttendance = async () => {
                if (!formData.date) return alert("Sila pilih tarikh dahulu.");
                try {
                    const q = query(collection(db, 'portal_attendance'), where('date', '==', formData.date));
                    const snap = await getDocs(q);
                    
                    if(snap.empty) return alert("Tiada rekod kehadiran untuk tarikh ini.");
                    
                    const stats = { d1: {h:0, t:0}, d2: {h:0, t:0}, d3: {h:0, t:0}, d4: {h:0, t:0}, d5: {h:0, t:0}, d6: {h:0, t:0}, pk: {h:0, t:0}, pra: {h:0, t:0} };
                    
                    snap.forEach(doc => {
                        const d = doc.data(); 
                        const cls = (d.className || "").toUpperCase(); 
                        const h = parseInt(d.stats?.hadir)||0; 
                        const t = parseInt(d.stats?.total)||0;

                        if (!cls) return;
                        
                        if (cls.includes('PPKI')) { stats.pk.h+=h; stats.pk.t+=t; }
                        else if (cls.includes('PRA')) { stats.pra.h+=h; stats.pra.t+=t; }
                        else {
                             // Check for year numbers (1-6) or words
                             if (cls.includes('1') || cls.includes('SATU')) { stats.d1.h+=h; stats.d1.t+=t; }
                             else if (cls.includes('2') || cls.includes('DUA')) { stats.d2.h+=h; stats.d2.t+=t; }
                             else if (cls.includes('3') || cls.includes('TIGA')) { stats.d3.h+=h; stats.d3.t+=t; }
                             else if (cls.includes('4') || cls.includes('EMPAT')) { stats.d4.h+=h; stats.d4.t+=t; }
                             else if (cls.includes('5') || cls.includes('LIMA')) { stats.d5.h+=h; stats.d5.t+=t; }
                             else if (cls.includes('6') || cls.includes('ENAM')) { stats.d6.h+=h; stats.d6.t+=t; }
                        }
                    });
                    
                    const newAtt = {}; 
                    Object.keys(stats).forEach(k => { newAtt[k] = `${stats[k].h}/${stats[k].t}`; });
                    setFormData(prev => ({ ...prev, attendance: newAtt })); 
                    alert("Kehadiran berjaya diselaraskan!");
                } catch (e) { console.error(e); alert("Ralat: " + e.message); }
            };

            const insertSuggestion = (text) => { setFormData(prev => ({ ...prev, activities: prev.activities ? prev.activities + '\n ' + text : ' ' + text })); };
            const addBullet = () => { setFormData(prev => ({ ...prev, activities: prev.activities ? prev.activities + '\n ' : ' ' })); };

            // AUTO DATE TO DAY (FIXED)
            const handleDateChange = (e) => {
                const val = e.target.value;
                const days = ['Ahad', 'Isnin', 'Selasa', 'Rabu', 'Khamis', 'Jumaat', 'Sabtu'];
                const d = new Date(val);
                const dayName = days[d.getDay()];
                setFormData(prev => ({ ...prev, date: val, day: dayName }));
            };

            if(mode === 'list') return (
                <div className="space-y-6 h-full flex flex-col relative">
                    <div className="flex justify-between items-center">
                        <h2 className="text-2xl font-bold text-slate-800 flex items-center gap-2"><FileText className="w-6 h-6 text-indigo-600"/> Arkib Laporan Mingguan</h2>
                        <button onClick={handleAddNew} className="bg-indigo-600 text-white px-4 py-2 rounded-lg font-bold shadow-md hover:bg-indigo-700 flex items-center gap-2"><Plus className="w-4 h-4"/> Laporan Baru</button>
                    </div>
                    
                    <div className="flex-1 overflow-y-auto pr-2 space-y-4">
                        {sortedWeeks.length === 0 ? (
                            <div className="p-12 text-center border-2 border-dashed border-slate-200 rounded-xl text-slate-400">
                                <p className="mb-2">Tiada laporan direkodkan.</p>
                                <button onClick={handleAddNew} className="text-indigo-600 font-bold hover:underline">Buat Laporan Pertama</button>
                            </div>
                        ) : (
                            sortedWeeks.map(weekNum => {
                                const weekReports = groupedReports[weekNum];
                                const isOpen = expandedWeeks[weekNum];
                                return (
                                    <div key={weekNum} className="bg-white border border-slate-200 rounded-xl shadow-sm overflow-hidden transition-all">
                                        <div onClick={() => toggleWeek(weekNum)} className={`p-4 flex justify-between items-center cursor-pointer hover:bg-slate-50 transition-colors ${isOpen ? 'bg-indigo-50/50 border-b border-indigo-100' : ''}`}>
                                            <div className="flex items-center gap-4">
                                                <div className={`w-10 h-10 rounded-full flex items-center justify-center font-bold text-lg shadow-sm ${isOpen ? 'bg-indigo-600 text-white' : 'bg-slate-100 text-slate-500'}`}>{weekNum === 'Lain-lain' ? '?' : weekNum}</div>
                                                <div><h3 className={`font-bold text-lg ${isOpen ? 'text-indigo-900' : 'text-slate-700'}`}>Minggu {weekNum === 'Lain-lain' ? 'Umum' : weekNum}</h3><p className="text-xs text-slate-500 font-medium">{weekReports.length} Laporan Harian</p></div>
                                            </div>
                                            <ChevronRight className={`w-5 h-5 text-slate-400 transition-transform duration-300 ${isOpen ? 'rotate-90' : ''}`}/>
                                        </div>
                                        {isOpen && (
                                            <div className="bg-slate-50/50 divide-y divide-slate-100 animate-fade-in">
                                                 <div className="grid grid-cols-12 px-4 py-2 bg-slate-100/50 text-[10px] font-bold text-slate-500 uppercase tracking-wider">
                                                    <div className="col-span-2">Hari - Tarikh</div>
                                                    <div className="col-span-4">Guru Bertugas</div>
                                                    <div className="col-span-3">Status</div>
                                                    <div className="col-span-3 text-right">Tindakan</div>
                                                 </div>
                                                {weekReports.map(r => (
                                                    <div key={r.id} className="grid grid-cols-12 px-4 py-3 items-center hover:bg-white transition-colors text-sm border-l-4 border-transparent hover:border-indigo-500">
                                                        <div className="col-span-2"><span className="block font-bold text-slate-700">{r.day || '-'}</span><span className="text-xs text-slate-500 font-mono">{formatDate(r.date)}</span></div>
                                                        <div className="col-span-4 text-slate-600 text-xs line-clamp-2">{r.teachersOnDuty.map(t=>t.name).join(', ')}</div>
                                                        <div className="col-span-3">{r.verifiedBy ? <span className="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-emerald-100 text-emerald-700 text-[10px] font-bold border border-emerald-200"><CheckCircle className="w-3 h-3"/> Disahkan</span> : <span className="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-amber-100 text-amber-700 text-[10px] font-bold border border-amber-200"><Clock className="w-3 h-3"/> Pending</span>}</div>
                                                        <div className="col-span-3 text-right flex justify-end gap-2">
                                                            <button onClick={()=>handleDuplicate(r)} className="p-1.5 text-slate-500 hover:text-indigo-600 hover:bg-indigo-50 rounded" title="Salin"><ClipboardList className="w-4 h-4"/></button>
                                                            <button onClick={()=>{setFormData({...initialForm, ...r}); setMode('form');}} className="p-1.5 text-slate-500 hover:text-blue-600 hover:bg-blue-50 rounded" title="Edit"><Edit3 className="w-4 h-4"/></button>
                                                            {(userData.role === 'admin' || r.createdBy === currentUid) && (
                                                                <button onClick={(e)=>requestDelete(r.id, r.createdBy, e)} className="p-1.5 text-slate-500 hover:text-red-600 hover:bg-red-50 rounded" title="Padam"><Trash2 className="w-4 h-4"/></button>
                                                            )}
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                );
                            })
                        )}
                    </div>
                    {reportToDelete && (
                        <ConfirmModal title="Padam Laporan?" msg="Adakah anda pasti mahu memadam laporan ini? Tindakan ini tidak boleh diundur." onConfirm={executeDeleteReport} onCancel={() => setReportToDelete(null)} />
                    )}
                </div>
            );

            // --- FULL FORM RENDER ---
            return (
                <div className="max-w-4xl mx-auto space-y-6">
                    <div className="flex justify-between items-center no-print sticky top-0 bg-[#F8FAFC] py-4 z-20 border-b border-slate-200">
                        <button onClick={()=>setMode('list')} className="text-slate-500 hover:text-indigo-600 font-bold flex items-center gap-1 bg-white border border-slate-300 px-3 py-1.5 rounded-lg shadow-sm"><ChevronLeft className="w-4 h-4"/> Kembali ke Senarai</button>
                        <div className="flex gap-2">
                             {(userData.role === 'pentadbir' || userData.role === 'admin') && !formData.verifiedBy && (
                                <button onClick={handleVerify} className="bg-emerald-600 text-white px-4 py-2 rounded-lg font-bold shadow hover:bg-emerald-700 flex items-center gap-2 animate-pulse"><CheckCircle className="w-4 h-4"/> Sahkan</button>
                             )}
                            <button onClick={handlePrint} className="bg-slate-100 text-slate-700 px-4 py-2 rounded-lg font-bold hover:bg-slate-200 flex items-center gap-2"><Printer className="w-4 h-4"/> Cetak</button>
                            <button onClick={handleSave} className="bg-indigo-600 text-white px-6 py-2 rounded-lg font-bold shadow-lg hover:bg-indigo-700 flex items-center gap-2"><Save className="w-4 h-4"/> Simpan Laporan</button>
                        </div>
                    </div>

                    <div className="bg-white p-8 md:p-12 shadow-lg border border-slate-200 print-container" id="report-print">
                        <div className="text-center border-b-2 border-slate-800 pb-4 mb-6">
                            <h1 className="text-2xl font-bold uppercase tracking-wide">SK Masjid Tanah (Integ)</h1>
                            <p className="text-sm text-slate-600">78300 Masjid Tanah, Melaka</p>
                            <h2 className="text-xl font-bold mt-4 uppercase underline decoration-2 underline-offset-4">Laporan Harian Guru Bertugas</h2>
                        </div>

                        <div className="grid grid-cols-3 gap-4 mb-6 border border-slate-300 p-4 rounded-lg bg-slate-50/50">
                            <div><label className="text-xs font-bold uppercase text-slate-500 block mb-1">Tarikh</label><input type="date" className="w-full bg-transparent font-bold border-b border-slate-300 outline-none" value={formData.date} onChange={handleDateChange}/></div>
                            <div><label className="text-xs font-bold uppercase text-slate-500 block mb-1">Hari</label><input className="w-full bg-transparent font-bold border-b border-slate-300 outline-none text-slate-500" value={formData.day} onChange={e=>setFormData({...formData, day:e.target.value})} /></div>
                            <div><label className="text-xs font-bold uppercase text-slate-500 block mb-1">Minggu</label><input type="number" className="w-full bg-transparent font-bold border-b border-slate-300 outline-none" placeholder="Contoh: 41" value={formData.week} onChange={e=>setFormData({...formData, week:e.target.value})}/></div>
                        </div>
                        
                        {/* GURU BERTUGAS */}
                        <div className="mb-6">
                            <div className="flex justify-between items-center mb-2"><h3 className="font-bold text-sm uppercase bg-slate-100 px-2 py-1 inline-block">Guru Bertugas</h3><button onClick={()=>setFormData({...formData, teachersOnDuty: [...formData.teachersOnDuty, {name:'', note:''}]})} className="text-xs text-blue-600 hover:underline no-print">+ Tambah Guru</button></div>
                            {formData.teachersOnDuty.map((t, idx) => (
                                <div key={idx} className="flex gap-2 mb-2 items-center">
                                    <span className="w-6 text-center font-bold text-slate-400">{idx+1}.</span>
                                    <select className="flex-1 border p-1 rounded text-sm" value={t.name} onChange={(e)=>{const n=[...formData.teachersOnDuty];n[idx].name=e.target.value;setFormData({...formData,teachersOnDuty:n})}}>
                                        <option value="">Pilih Guru</option>{teachers.map(x=><option key={x.id} value={x.name}>{x.name}</option>)}
                                    </select>
                                    <input className="flex-1 border p-1 rounded text-sm" placeholder="Catatan (Pagar/Kantin)" value={t.note} onChange={(e)=>{const n=[...formData.teachersOnDuty];n[idx].note=e.target.value;setFormData({...formData,teachersOnDuty:n})}}/>
                                    <button onClick={()=>{const n=formData.teachersOnDuty.filter((_,i)=>i!==idx);setFormData({...formData,teachersOnDuty:n})}} className="text-red-500"><X size={16}/></button>
                                </div>
                            ))}
                        </div>
                        
                        {/* GURU TIDAK HADIR */}
                        <div className="mb-6">
                            <div className="flex justify-between items-center mb-2"><h3 className="font-bold text-sm uppercase bg-slate-100 px-2 py-1 inline-block text-red-600">Guru Tidak Hadir</h3><button onClick={()=>setFormData({...formData, teachersAbsent: [...(formData.teachersAbsent||[]), {name:'', note:''}]})} className="text-xs text-blue-600 hover:underline no-print">+ Tambah Guru Tidak Hadir</button></div>
                            {(!formData.teachersAbsent || formData.teachersAbsent.length===0) ? <p className="text-sm text-slate-400 italic mb-2 px-4">Tiada rekod guru tidak hadir.</p> : 
                                formData.teachersAbsent.map((t, idx) => (
                                <div key={idx} className="flex gap-2 mb-2 items-center">
                                    <span className="w-6 text-center font-bold text-slate-400">{idx+1}.</span>
                                    <select className="flex-1 border p-1 rounded text-sm" value={t.name} onChange={(e)=>{const n=[...formData.teachersAbsent];n[idx].name=e.target.value;setFormData({...formData,teachersAbsent:n})}}>
                                        <option value="">Pilih Guru</option>{teachers.map(x=><option key={x.id} value={x.name}>{x.name}</option>)}
                                    </select>
                                    <input className="flex-1 border p-1 rounded text-sm" placeholder="Sebab (MC/CRK/Kursus)" value={t.note} onChange={(e)=>{const n=[...formData.teachersAbsent];n[idx].note=e.target.value;setFormData({...formData,teachersAbsent:n})}}/>
                                    <button onClick={()=>{const n=formData.teachersAbsent.filter((_,i)=>i!==idx);setFormData({...formData,teachersAbsent:n})}} className="text-red-500"><X size={16}/></button>
                                </div>
                            ))}
                        </div>

                        {/* LAPORAN AKTIVITI */}
                        <div className="mb-6">
                            <h3 className="font-bold bg-slate-100 p-2 mb-2 text-sm uppercase flex justify-between items-center">
                                <span>Laporan / Aktiviti</span> 
                                <div className="flex gap-2 no-print">
                                    <button onClick={addBullet} className="bg-white border px-2 py-0.5 rounded text-xs hover:bg-slate-50 flex items-center gap-1"><Plus size={10}/> Bullet</button>
                                    <button onClick={()=>setShowSuggestions(true)} className="bg-indigo-600 text-white px-2 py-0.5 rounded text-xs hover:bg-indigo-700 flex items-center gap-1"><List size={12}/> Cadangan</button>
                                </div>
                            </h3>
                            <textarea className="w-full border border-slate-300 rounded p-3 text-sm h-32 resize-none focus:ring-1 focus:ring-indigo-500 outline-none" placeholder=" Laporan aktiviti harian..." value={formData.activities} onChange={e=>setFormData({...formData,activities:e.target.value})}></textarea>
                            
                            {/* POPUP CADANGAN */}
                            {showSuggestions && (
                                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center no-print">
                                    <div className="bg-white rounded-xl w-96 p-6 shadow-2xl animate-fade-in">
                                        <h3 className="font-bold mb-4 flex justify-between items-center text-slate-800">
                                            Pilih Cadangan Laporan
                                            <button onClick={()=>setShowSuggestions(false)} className="text-slate-400 hover:text-red-500"><X size={18}/></button>
                                        </h3>
                                        <div className="flex gap-2 mb-4 border-b border-slate-100 pb-2">
                                            {Object.keys(suggestions).map(t => (
                                                <button key={t} onClick={()=>setSuggestionTab(t)} className={`px-3 py-1.5 rounded-lg text-xs font-bold capitalize transition-all ${suggestionTab===t?'bg-indigo-100 text-indigo-700':'text-slate-500 hover:bg-slate-50'}`}>
                                                    {t}
                                                </button>
                                            ))}
                                        </div>
                                        <div className="space-y-2 max-h-60 overflow-y-auto pr-1">
                                            {suggestions[suggestionTab].map((s,i)=>(
                                                <button key={i} onClick={()=>{insertSuggestion(s);setShowSuggestions(false)}} className="w-full text-left text-xs p-2.5 hover:bg-indigo-50 border border-slate-100 rounded-lg text-slate-700 transition-colors">
                                                    {s}
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                        
                        {/* KEHADIRAN (BUTTON SELARAS) */}
                        <div className="mb-6">
                            <h3 className="font-bold bg-slate-100 p-2 mb-2 text-sm uppercase flex justify-between items-center">
                                <span>Kehadiran Murid</span> 
                                <button onClick={syncAttendance} className="text-xs bg-white border border-slate-300 px-2 py-0.5 rounded flex items-center gap-1 hover:bg-emerald-50 hover:text-emerald-700 hover:border-emerald-200 transition-colors no-print"><RefreshCw size={10}/> Selaras Harian</button>
                            </h3>
                            <div className="grid grid-cols-8 border border-slate-300 text-center text-sm">
                                {['D1','D2','D3','D4','D5','D6','PK','PRA'].map(c=>(
                                    <div key={c} className="border-r border-slate-300 last:border-r-0">
                                        <div className="bg-slate-50 font-bold p-1 border-b border-slate-300">{c}</div>
                                        <input className="w-full text-center p-1 outline-none" value={formData.attendance[c.toLowerCase()]} onChange={e=>setFormData({...formData,attendance:{...formData.attendance,[c.toLowerCase()]:e.target.value}})}/>
                                    </div>
                                ))}
                            </div>
                        </div>
                        
                        {/* PEMANTAUAN KANTIN & 3K */}
                        <div className="grid grid-cols-2 gap-6 mb-6">
                            {Object.entries({kantin:'Kantin', makanan:'Makanan', sekolah:'Sekolah', tandas:'Tandas'}).map(([key, label]) => (
                                <div key={key} className="border border-slate-300 rounded p-3">
                                    <h4 className="font-bold text-xs uppercase mb-2 text-slate-700">{label}</h4>
                                    <select className="w-full border border-slate-300 rounded p-1 text-sm mb-2 outline-none bg-white focus:border-indigo-500" value={formData.checks[key].level} onChange={e=>setFormData({...formData, checks: {...formData.checks, [key]: {...formData.checks[key], level: e.target.value}}})}><option>Baik</option><option>Sederhana</option><option>Lemah</option></select>
                                    <input className="w-full text-xs border-b border-slate-200 outline-none py-1 italic text-slate-500" placeholder="Ulasan..." value={formData.checks[key].comment} onChange={e=>setFormData({...formData, checks: {...formData.checks, [key]: {...formData.checks[key], comment: e.target.value}}})}/>
                                </div>
                            ))}
                        </div>

                        <div className="grid grid-cols-2 gap-6 mb-8">
                            <div><h3 className="font-bold text-sm uppercase bg-slate-100 px-2 py-1 inline-block mb-2">Kesihatan / Sakit</h3><textarea className="w-full border border-slate-300 rounded p-2 text-sm h-20 resize-none outline-none" value={formData.health} onChange={e=>setFormData({...formData, health:e.target.value})} placeholder="Senarai murid sakit..."></textarea></div>
                            <div><h3 className="font-bold text-sm uppercase bg-slate-100 px-2 py-1 inline-block mb-2">Hal-hal Lain</h3><textarea className="w-full border border-slate-300 rounded p-2 text-sm h-20 resize-none outline-none" value={formData.other} onChange={e=>setFormData({...formData, other:e.target.value})} placeholder="Catatan tambahan..."></textarea></div>
                        </div>

                        <div className="grid grid-cols-2 gap-12 mt-12 pt-4">
                            <div className="text-center">
                                <p className="text-sm font-bold border-b border-black mb-1 pb-1">{formData.preparedBy}</p>
                                <p className="text-xs text-slate-500 uppercase">Disediakan Oleh (Guru Bertugas)</p>
                            </div>
                            <div className="text-center">
                                <p className="text-sm font-bold border-b border-black mb-1 pb-1">{formData.verifiedBy || '.'}</p>
                                <p className="text-xs text-slate-500 uppercase">Disahkan Oleh (Pentadbir) {formData.verifiedAt && <span className="block text-[10px] normal-case mt-1 text-emerald-600">({formatDate(formData.verifiedAt)})</span>}</p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function AppBuilder({ apps }) {
          const [form, setForm] = useState({ title: '', desc: '', iconKey: 'portal', category: 'umum', type: 'link', content: '' });
          const [confirmDel, setConfirmDel] = useState(null);
          const [editingId, setEditingId] = useState(null);
          
          const handleSave = async () => { 
              if(!form.title) return alert("Sila isi tajuk aplikasi."); 
              
              try {
                  if (editingId) {
                      await updateDoc(doc(db, 'portal_apps', editingId), form);
                      alert("Aplikasi berjaya dikemaskini!");
                  } else {
                      await addDoc(collection(db, 'portal_apps'), form); 
                      alert("Aplikasi berjaya diterbitkan!");
                  }
                  
                  // Reset form
                  setForm({ title: '', desc: '', iconKey: 'portal', category: 'umum', type: 'link', content: '' });
                  setEditingId(null);
              } catch (e) {
                  alert("Ralat: " + e.message);
              }
          };

          const handleEdit = (app) => {
              setForm(app);
              setEditingId(app.id);
          };

          const handleCancel = () => {
              setForm({ title: '', desc: '', iconKey: 'portal', category: 'umum', type: 'link', content: '' });
              setEditingId(null);
          };

          const executeDelete = async () => { 
              if(confirmDel) { 
                  await deleteDoc(doc(db, 'portal_apps', confirmDel)); 
                  setConfirmDel(null); 
                  if (editingId === confirmDel) handleCancel(); // Reset form if deleting currently edited item
              } 
          };
          
          const handleContentChange = (e) => {
              const val = e.target.value;
              const newForm = { ...form, content: val };
              if (val.includes("import React") || val.includes("from 'react'") || val.includes("export default")) {
                  newForm.type = 'react';
              } else if (val.trim().startsWith('<') && !val.includes("import React")) {
                  newForm.type = 'html';
              } else if (val.startsWith('http')) {
                  newForm.type = 'link';
              }
              setForm(newForm);
          };

          return (
            <div className="grid lg:grid-cols-12 gap-8 h-[calc(100vh-140px)]">
                <div className="lg:col-span-8 bg-white rounded-xl border border-slate-200 p-6 flex flex-col h-full overflow-hidden">
                    <div className="flex justify-between items-center mb-4">
                        <h3 className="font-bold text-lg text-slate-800 flex items-center gap-2">
                            {editingId ? <><Edit3 className="w-5 h-5 text-blue-600"/> Kemaskini Aplikasi</> : <><Plus className="w-5 h-5 text-indigo-600"/> Bina Aplikasi Baru</>}
                        </h3>
                        {editingId && (
                            <button onClick={handleCancel} className="text-xs bg-slate-100 text-slate-600 px-3 py-1 rounded-full font-bold hover:bg-slate-200">
                                Batal Edit
                            </button>
                        )}
                    </div>
                    
                    <div className="space-y-4 flex-1 overflow-y-auto pr-2">
                        {/* Title Input */}
                        <div>
                            <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Tajuk Aplikasi</label>
                            <input 
                                className="w-full p-3 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all" 
                                value={form.title} 
                                onChange={e=>setForm({...form, title:e.target.value})} 
                                placeholder="Contoh: Kuiz Matematik Tahun 6"
                            />
                        </div>

                        {/* Description Input */}
                        <div>
                            <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Deskripsi Ringkas</label>
                            <textarea 
                                className="w-full p-3 border border-slate-300 rounded-lg text-sm h-24 resize-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all" 
                                value={form.desc} 
                                onChange={e=>setForm({...form, desc:e.target.value})} 
                                placeholder="Penerangan pendek tentang fungsi aplikasi ini..."
                            />
                        </div>

                        <div className="flex flex-col gap-2">
                            <label className="block text-xs font-bold text-slate-500 uppercase">Jenis Kandungan</label>
                            <div className="flex gap-2">
                                <button onClick={()=>setForm({...form, type:'link'})} className={`flex-1 py-2 rounded-lg text-xs font-bold border transition-all ${form.type==='link'?'bg-indigo-600 text-white border-indigo-600 shadow-md':'bg-white text-slate-600 border-slate-200 hover:bg-slate-50'}`}>Pautan URL</button>
                                <button onClick={()=>setForm({...form, type:'html'})} className={`flex-1 py-2 rounded-lg text-xs font-bold border transition-all ${form.type==='html'?'bg-indigo-600 text-white border-indigo-600 shadow-md':'bg-white text-slate-600 border-slate-200 hover:bg-slate-50'}`}>Kod HTML</button>
                                <button onClick={()=>setForm({...form, type:'react'})} className={`flex-1 py-2 rounded-lg text-xs font-bold border transition-all ${form.type==='react'?'bg-indigo-600 text-white border-indigo-600 shadow-md':'bg-white text-slate-600 border-slate-200 hover:bg-slate-50'}`}>React (Beta)</button>
                            </div>
                        </div>

                        {/* Content Area */}
                        <div>
                            <label className="block text-xs font-bold text-slate-500 uppercase mb-1">
                                {form.type === 'link' ? 'URL Pautan' : 'Kod Sumber'}
                            </label>
                            {form.type==='link' ? (
                                <input 
                                    className="w-full p-3 border border-slate-300 rounded-lg text-sm font-mono text-blue-600 focus:ring-2 focus:ring-indigo-500 outline-none" 
                                    value={form.content} 
                                    onChange={e=>setForm({...form, content:e.target.value})} 
                                    placeholder="https://..."
                                />
                            ) : (
                                <div className="relative border border-slate-300 rounded-lg overflow-hidden">
                                    <textarea 
                                        className="w-full h-64 p-4 font-mono text-xs bg-slate-900 text-green-400 outline-none resize-none" 
                                        value={form.content} 
                                        onChange={handleContentChange} 
                                        placeholder={form.type === 'react' ? "function App() { return <div className='p-4'>Hello Cikgu!</div> }" : "<!-- Masukkan kod HTML di sini -->"}
                                    />
                                    {form.type === 'react' && <div className="absolute bottom-0 left-0 right-0 bg-slate-800 text-slate-400 text-[10px] p-2 text-center border-t border-slate-700">Paste kod React penuh. Sistem akan render secara automatik.</div>}
                                </div>
                            )}
                        </div>

                        {/* Icon Selector */}
                        <div>
                            <label className="block text-xs font-bold text-slate-500 uppercase mb-2">Pilih Ikon</label>
                            <div className="flex gap-3 overflow-x-auto pb-2 scrollbar-thin">
                                {Object.entries(ALL_ICONS).map(([k, d]) => (
                                    <button 
                                        key={k} 
                                        onClick={() => setForm({...form, iconKey: k})} 
                                        className={`p-3 rounded-xl border transition-all flex-shrink-0 ${form.iconKey === k ? 'border-indigo-600 bg-indigo-50 ring-2 ring-indigo-200 shadow-sm transform scale-110' : 'border-slate-200 bg-white hover:border-slate-300 hover:bg-slate-50'}`} 
                                        title={k}
                                    >
                                        <d.i className={`w-6 h-6 ${d.color}`}/>
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>

                    <div className="pt-4 mt-2 border-t border-slate-100">
                        <button 
                            onClick={handleSave} 
                            className={`w-full py-3 rounded-xl font-bold text-white shadow-lg transition-all transform hover:-translate-y-1 active:scale-95 ${editingId ? 'bg-blue-600 hover:bg-blue-700' : 'bg-indigo-600 hover:bg-indigo-700'}`}
                        >
                            {editingId ? 'Kemaskini Aplikasi' : 'Terbitkan Aplikasi'}
                        </button>
                    </div>
                </div>

                {/* Sidebar List */}
                <div className="lg:col-span-4 bg-white rounded-xl border border-slate-200 flex flex-col h-full overflow-hidden">
                    <div className="p-4 border-b border-slate-100 bg-slate-50">
                        <h3 className="font-bold text-slate-700 text-sm">Senarai Aplikasi ({apps.length})</h3>
                    </div>
                    <div className="flex-1 overflow-y-auto p-2 space-y-2">
                        {apps.length === 0 ? <p className="text-center text-slate-400 text-xs py-8">Belum ada aplikasi.</p> : apps.map(a=>(
                            <div key={a.id} className={`group flex justify-between items-start p-3 rounded-xl border transition-all hover:shadow-md ${editingId === a.id ? 'bg-blue-50 border-blue-200 ring-1 ring-blue-300' : 'bg-white border-slate-100 hover:border-indigo-200'}`}>
                                <div className="flex items-start gap-3 overflow-hidden">
                                    <div className={`p-2 rounded-lg shrink-0 ${ALL_ICONS[a.iconKey]?.bg || 'bg-slate-100'}`}>
                                        {React.createElement(ALL_ICONS[a.iconKey]?.i || Globe, { className: `w-4 h-4 ${ALL_ICONS[a.iconKey]?.color || 'text-slate-600'}` })}
                                    </div>
                                    <div className="min-w-0">
                                        <h4 className="font-bold text-sm text-slate-800 truncate">{a.title}</h4>
                                        <span className="text-[10px] uppercase font-bold text-slate-400 bg-slate-100 px-1.5 py-0.5 rounded">{a.type}</span>
                                    </div>
                                </div>
                                <div className="flex gap-1 opacity-100 lg:opacity-0 group-hover:opacity-100 transition-opacity">
                                    <button onClick={()=>handleEdit(a)} className="p-1.5 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors" title="Edit">
                                        <Edit3 className="w-4 h-4"/>
                                    </button>
                                    <button onClick={()=>setConfirmDel(a.id)} className="p-1.5 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors" title="Padam">
                                        <Trash2 className="w-4 h-4"/>
                                    </button>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
                {confirmDel && <ConfirmModal title="Padam Aplikasi?" msg="Tindakan ini tidak boleh diundur. Adakah anda pasti?" onConfirm={executeDelete} onCancel={()=>setConfirmDel(null)}/>}
            </div>
          );
        }

        function AppGallery({ apps }) {
          const [sel, setSel] = useState(null);
          
          const generateReactHtml = (code) => {
              // Handle "export default ComponentName" pattern
              let modifiedCode = code;
              const exportMatch = code.match(/export\s+default\s+(\w+)/);
              if (exportMatch && exportMatch[1]) {
                  // We strip the export default statement to avoid syntax errors in non-module script
                  // And we alias the component to 'App' so the render function can find it
                  modifiedCode = code.replace(/export\s+default\s+\w+;?/g, ''); 
                  modifiedCode += `\n\n// Auto-assigned by System\nconst App = ${exportMatch[1]};`;
              }

              return `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8" />
                    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
                    <script src="https://cdn.tailwindcss.com"><\/script>
                    <script src="https://unpkg.com/@babel/standalone/babel.min.js"><\/script>
                    <script type="importmap">
                    {
                      "imports": {
                        "react": "https://esm.sh/react@18.2.0",
                        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
                        "lucide-react": "https://esm.sh/lucide-react@0.292.0"
                      }
                    }
                    <\/script>
                    <style>body { font-family: sans-serif; background-color: #ffffff; }</style>
                </head>
                <body>
                    <div id="root"></div>
                    <script type="text/babel" data-type="module">
                        import React, { useState, useEffect, useRef } from 'react';
                        import { createRoot } from 'react-dom/client';
                        import * as LucideIcons from 'lucide-react';
                        
                        // We make LucideIcons available globally if needed, 
                        // though the importmap handles imports within the pasted code mostly.
                        window.LucideIcons = LucideIcons;

                        try {
                            ${modifiedCode}

                            if (typeof App !== 'undefined') {
                                const root = createRoot(document.getElementById('root'));
                                root.render(<App />);
                            } else {
                                document.getElementById('root').innerHTML = '<div style="color:red; padding:20px; font-weight:bold;">Ralat: Komponen utama tidak dijumpai. Pastikan anda menggunakan "export default NamaComponent" atau namakan komponen sebagai "App".</div>';
                            }
                        } catch (err) {
                            document.getElementById('root').innerHTML = '<div style="color:red; padding:20px;">Ralat Sintaks: ' + err.message + '</div>';
                        }
                    <\/script>
                </body>
                </html>
              `;
          };

          if(sel) return (<div className="h-[80vh] bg-white rounded-xl border border-slate-200 flex flex-col"><div className="p-4 border-b flex justify-between"><button onClick={()=>setSel(null)} className="flex items-center gap-1 font-bold text-slate-600"><ChevronRight className="rotate-180 w-4 h-4"/> Kembali</button><h3 className="font-bold">{sel.title}</h3></div><div className="flex-1 relative bg-white">{sel.type === 'link' ? <iframe src={sel.content} className="w-full h-full border-none"/> : <iframe srcDoc={sel.type === 'react' ? generateReactHtml(sel.content) : sel.content} className="w-full h-full border-none" sandbox="allow-scripts allow-same-origin allow-forms allow-popups"/>}</div></div>);
          return (<div className="grid grid-cols-2 md:grid-cols-4 gap-4">{apps.map(a=>(<div key={a.id} onClick={()=>setSel(a)} className="bg-white p-4 rounded-xl border hover:shadow-md cursor-pointer flex flex-col h-40 justify-between"><div className="flex justify-between"><div className={`p-2 rounded-lg ${ALL_ICONS[a.iconKey]?.bg || 'bg-slate-100'}`}>{React.createElement(ALL_ICONS[a.iconKey]?.i || Globe, { className: `w-6 h-6 ${ALL_ICONS[a.iconKey]?.color || 'text-slate-600'}` })}</div></div><div><h4 className="font-bold truncate">{a.title}</h4><p className="text-xs text-slate-500 line-clamp-2">{a.desc}</p></div></div>))}</div>);
        }

        function AttendanceManager({ students, userData, preSelectedClass }) {
            const [selectedClass, setSelectedClass] = useState(preSelectedClass || "");
            const [attendanceData, setAttendanceData] = useState({});
            const [today, setToday] = useState(new Date().toISOString().split('T')[0]);
            const [loading, setLoading] = useState(false);
            const [showSummary, setShowSummary] = useState(false);
            const [summaryData, setSummaryData] = useState(null);
            const [history, setHistory] = useState([]);
            const [filterDate, setFilterDate] = useState("");
            const classList = [...new Set(students.map(s => s.class))].sort();
            const classStudents = students.filter(s => s.class === selectedClass).sort((a,b) => a.name.localeCompare(b.name));

            useEffect(() => { if(selectedClass) { const i = {}; classStudents.forEach(s => { i[s.id] = 'Hadir'; }); setAttendanceData(i); } }, [selectedClass]);
            useEffect(() => { const q = query(collection(db, 'portal_attendance'), orderBy('submittedAt', 'desc')); const unsub = onSnapshot(q, s => setHistory(s.docs.map(d => ({id: d.id, ...d.data()})))); return () => unsub(); }, []);

            const submitAttendance = async () => { if(!selectedClass) return alert("Pilih kelas."); setLoading(true); try { let h=0, th=0, l=0; Object.values(attendanceData).forEach(s => { if(s==='Hadir') h++; else if(s==='Tidak Hadir') th++; else l++; }); const docId = `${today}_${selectedClass.replace(/\s+/g, '_')}`; const payload = { date: today, className: selectedClass, records: attendanceData, stats: { hadir:h, tidakHadir:th, lewat:l, total: classStudents.length }, submittedBy: userData.name, submittedAt: new Date().toISOString() }; await setDoc(doc(db, 'portal_attendance', docId), payload); setSummaryData(payload.stats); setShowSummary(true); } catch(e){console.error(e);alert("Ralat.");} setLoading(false); };
            const handleEdit = (rec) => { setSelectedClass(rec.className); setToday(rec.date); setAttendanceData(rec.records); window.scrollTo({ top: 0, behavior: 'smooth' }); };
            const filteredHistory = history.filter(h => filterDate ? h.date === filterDate : true);

            return (
                <div className="max-w-4xl mx-auto space-y-8 animate-fade-in">
                    <div className="flex justify-between items-center"><h2 className="text-2xl font-bold text-slate-800 flex items-center gap-2"><UserCheck className="w-6 h-6 text-indigo-600"/> Kehadiran Murid</h2><div className="bg-white px-4 py-2 rounded-lg border text-sm font-bold text-slate-600">Tarikh: {formatDate(today)}</div></div>
                    <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm"><div className="mb-6"><label className="lbl text-base">Pilih Kelas (Atau pilih tarikh dahulu untuk kemaskini)</label><div className="flex gap-2"><input type="date" className="border rounded px-3 py-2 w-1/3 text-sm font-bold" value={today} onChange={e=>setToday(e.target.value)} /><select className="w-2/3 p-3 border rounded-lg font-bold bg-slate-50" value={selectedClass} onChange={(e) => setSelectedClass(e.target.value)}><option value="">-- Pilih Kelas --</option>{classList.map(c => <option key={c} value={c}>{c}</option>)}</select></div></div>{selectedClass && <><div className="overflow-x-auto border rounded-lg mb-6"><table className="w-full text-sm text-left"><thead className="bg-slate-100 text-xs uppercase"><tr><th className="p-3 w-10">Bil</th><th className="p-3">Nama</th><th className="p-3 text-center">Status</th></tr></thead><tbody className="divide-y">{classStudents.map((s, i) => (<tr key={s.id}><td className="p-3 text-center">{i + 1}</td><td className="p-3 font-bold">{s.name}</td><td className="p-3 flex justify-center gap-2">{['Hadir', 'Tidak Hadir', 'Lewat'].map(st => <button key={st} onClick={() => setAttendanceData(p => ({ ...p, [s.id]: st }))} className={`px-3 py-1 rounded text-xs font-bold border ${attendanceData[s.id] === st ? (st==='Hadir'?'bg-emerald-100 border-emerald-300':st==='Tidak Hadir'?'bg-red-100 border-red-300':'bg-amber-100 border-amber-300') : 'bg-slate-50'}`}>{st}</button>)}</td></tr>))}</tbody></table></div><button onClick={submitAttendance} className="bg-indigo-600 text-white w-full py-3 rounded-lg font-bold">Hantar Kehadiran</button></>}</div>
                    <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm mt-8"><div className="flex justify-between items-center mb-4"><h3 className="font-bold text-slate-800 flex items-center gap-2"><History className="w-5 h-5 text-indigo-600"/> Sejarah Kehadiran</h3><div className="flex items-center gap-2"><span className="text-xs font-bold text-slate-500">Filter Tarikh:</span><input type="date" className="border rounded px-2 py-1 text-xs" value={filterDate} onChange={e => setFilterDate(e.target.value)} />{filterDate && <button onClick={()=>setFilterDate("")} className="text-xs text-red-500 font-bold">Reset</button>}</div></div><div className="overflow-x-auto"><table className="w-full text-sm text-left"><thead className="bg-slate-50 text-slate-500 font-bold uppercase text-xs"><tr><th className="p-3">Tarikh</th><th className="p-3">Kelas</th><th className="p-3 text-center">Hadir</th><th className="p-3 text-center">TH</th><th className="p-3 text-center">Lewat</th><th className="p-3 text-right"></th></tr></thead><tbody className="divide-y divide-slate-100">{filteredHistory.map(rec => (<tr key={rec.id}><td className="p-3 font-mono">{formatDate(rec.date)}</td><td className="p-3 font-bold">{rec.className}</td><td className="p-3 text-center font-bold text-emerald-600">{rec.stats.hadir}</td><td className="p-3 text-center font-bold text-red-600">{rec.stats.tidakHadir}</td><td className="p-3 text-center font-bold text-amber-600">{rec.stats.lewat}</td><td className="p-3 text-right"><button onClick={() => handleEdit(rec)} className="bg-blue-50 text-blue-600 px-3 py-1 rounded text-xs font-bold">Edit</button></td></tr>))}</tbody></table></div></div>
                    {showSummary && <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 animate-fade-in"><div className="bg-white p-8 rounded-2xl w-96 text-center shadow-2xl"><h3 className="font-bold text-xl mb-4 text-emerald-600">Berjaya!</h3><div className="grid grid-cols-3 gap-2 mb-6"><div className="bg-emerald-50 p-2 rounded border border-emerald-100">H: {summaryData.hadir}</div><div className="bg-red-50 p-2 rounded border border-red-100">TH: {summaryData.tidakHadir}</div><div className="bg-amber-50 p-2 rounded border border-amber-100">L: {summaryData.lewat}</div></div><button onClick={() => {setShowSummary(false); window.scrollTo({top: 1000, behavior: 'smooth'});}} className="bg-slate-800 text-white w-full py-2 rounded-lg font-bold">Tutup</button></div></div>}
                </div>
            );
        }

        function AgihanTugasManager({ teachers, canEdit }) {
            const [activeTab, setActiveTab] = useState('pentadbiran'); const [assignments, setAssignments] = useState({}); const [taskStructure, setTaskStructure] = useState(DEFAULT_TASKS); const [loading, setLoading] = useState(true); const [editMode, setEditMode] = useState(false); const [showAddModal, setShowAddModal] = useState(false); const [newTaskName, setNewTaskName] = useState(""); const [showDeleteModal, setShowDeleteModal] = useState(false); const [taskToDelete, setTaskToDelete] = useState(null);
            useEffect(() => { const u1 = onSnapshot(collection(db, 'portal_assignments'), s => { const d = {}; s.docs.forEach(doc => { d[doc.id] = doc.data(); }); setAssignments(d); }); const f = async () => { const s = await getDoc(doc(db, 'portal_settings', 'agihan_tugas_structure')); if (s.exists()) setTaskStructure(s.data().structure); setLoading(false); }; f(); return () => u1(); }, []);
            const saveStructure = async (ns) => { setTaskStructure(ns); await setDoc(doc(db, 'portal_settings', 'agihan_tugas_structure'), { structure: ns }); };
            const handleAssign = async (cat, task, tid) => { if (!canEdit) return; const t = teachers.find(x => x.id === tid); const did = `${cat}_${task.replace(/[^a-zA-Z0-9]/g, '_')}`; await setDoc(doc(db, 'portal_assignments', did), { category: cat, taskName: task, teacherId: tid, teacherName: t ? t.name : '', updatedAt: new Date().toISOString() }); };
            return (<div className="space-y-6 h-full flex flex-col relative"><div className="flex justify-between items-center"><h2 className="text-2xl font-bold text-slate-800 flex items-center gap-2"><Briefcase className="w-6 h-6 text-indigo-600"/> Agihan Tugas</h2>{canEdit && <button onClick={() => setEditMode(!editMode)} className="text-xs bg-slate-100 px-3 py-1.5 rounded-lg font-bold">{editMode ? 'Selesai' : 'Edit Senarai'}</button>}</div><div className="flex gap-2 overflow-x-auto pb-2 border-b">{[{ id: 'pentadbiran', l: 'Pentadbiran' }, { id: 'kurikulum', l: 'Kurikulum' }, { id: 'hem', l: 'HEM' }, { id: 'kokurikulum', l: 'Koko' }, { id: 'kelas', l: 'Guru Kelas' }].map(c => <button key={c.id} onClick={() => setActiveTab(c.id)} className={`px-4 py-2 rounded-lg text-sm font-bold whitespace-nowrap ${activeTab === c.id ? 'bg-indigo-600 text-white' : 'bg-white border'}`}>{c.l}</button>)}</div><div className="bg-white border rounded-xl flex-1 overflow-y-auto p-6">{loading ? <Loader2 className="animate-spin" /> : <div className="grid grid-cols-2 gap-4">{(taskStructure[activeTab] || []).map((t, i) => { const did = `${activeTab}_${t.replace(/[^a-zA-Z0-9]/g, '_')}`; const ad = assignments[did] || {}; return (<div key={i} className="border-b pb-2"><div className="flex justify-between"><label className="text-sm font-bold text-slate-700">{t}</label>{editMode && <button onClick={() => { setTaskToDelete(t); setShowDeleteModal(true); }} className="text-red-500"><Trash2 size={14} /></button>}</div>{!editMode && <select className="w-full border p-2 rounded text-sm mt-1" value={ad.teacherId || ""} onChange={(e) => handleAssign(activeTab, t, e.target.value)} disabled={!canEdit}><option value="">-- Pilih --</option>{teachers.map(x => <option key={x.id} value={x.id}>{x.name}</option>)}</select>}</div>) })}{editMode && <button onClick={() => setShowAddModal(true)} className="col-span-2 border-2 border-dashed p-4 rounded text-indigo-500 font-bold">+ Tambah Jawatan</button>}</div>}</div>{showAddModal && <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50"><div className="bg-white p-6 rounded-xl w-96"><h3 className="font-bold mb-4">Tambah</h3><input className="inp mb-4" value={newTaskName} onChange={e => setNewTaskName(e.target.value)} /><div className="flex justify-end gap-2"><button onClick={() => { const ns = { ...taskStructure }; if (!ns[activeTab]) ns[activeTab] = []; ns[activeTab].push(newTaskName); saveStructure(ns); setShowAddModal(false); setNewTaskName(""); }} className="bg-indigo-600 text-white px-4 py-2 rounded font-bold">Simpan</button></div></div></div>}{showDeleteModal && <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50"><div className="bg-white p-6 rounded-xl w-80"><h3 className="font-bold text-red-600 mb-4">Padam?</h3><p className="mb-4 text-sm">{taskToDelete}</p><div className="flex justify-end gap-2"><button onClick={() => setShowDeleteModal(false)} className="px-4 py-2 rounded bg-slate-100 font-bold">Batal</button><button onClick={() => { const ns = { ...taskStructure }; ns[activeTab] = ns[activeTab].filter(x => x !== taskToDelete); saveStructure(ns); setShowDeleteModal(false); }} className="px-4 py-2 rounded bg-red-600 text-white font-bold">Ya</button></div></div></div>}</div>);
        }

        function DataTable({ type, data, currentUserRole }) {
            const isReadOnly = currentUserRole === 'pentadbir'; const [newRec, setNewRec] = useState({}); const [editingId, setEditingId] = useState(null); const [selectedIds, setSelectedIds] = useState([]); const [filterClass, setFilterClass] = useState(""); const [sortOrder, setSortOrder] = useState('asc');
            const classList = type === 'student' ? [...new Set(data.map(d => d.class))].sort() : [];
            const processedData = useMemo(() => { let r = [...data]; if (type === 'student' && filterClass) r = r.filter(d => d.class === filterClass); r.sort((a, b) => { const nA = (a.name || '').toLowerCase(); const nB = (b.name || '').toLowerCase(); return sortOrder === 'asc' ? nA.localeCompare(nB) : nB.localeCompare(nA); }); return r; }, [data, filterClass, sortOrder, type]);
            
            // FIX: save function now correctly updates portal_users if teacher role is changed
            const save = async (e) => { 
                e.preventDefault(); 
                if (isReadOnly) return; 
                const col = type === 'student' ? 'portal_students' : 'portal_teachers'; 
                
                // Ensure role defaults to 'guru' if undefined (safety check)
                const finalRec = { ...newRec };
                if (type === 'teacher' && !finalRec.role) finalRec.role = 'guru';
                if (type === 'teacher' && !finalRec.position) finalRec.position = 'GAB';

                if (editingId) 
                    await updateDoc(doc(db, col, editingId), finalRec); 
                else 
                    await addDoc(collection(db, col), finalRec); 

                // --- FIX START: Sync Role to portal_users ---
                if (type === 'teacher' && finalRec.email) {
                    try {
                        const q = query(collection(db, 'portal_users'), where("email", "==", finalRec.email));
                        const snap = await getDocs(q);
                        if (!snap.empty) {
                            const batch = writeBatch(db);
                            snap.forEach(d => {
                                batch.update(doc(db, 'portal_users', d.id), { role: finalRec.role });
                            });
                            await batch.commit();
                        }
                    } catch(err) { console.error("Sync role error:", err); }
                }
                // --- FIX END ---

                setNewRec({}); setEditingId(null); alert("Disimpan!"); 
            };

            const del = async (id) => { if (confirm("Padam?")) await deleteDoc(doc(db, type === 'student' ? 'portal_students' : 'portal_teachers', id)); };
            const bulkDel = async () => { if (confirm(`Padam ${selectedIds.length}?`)) { const b = writeBatch(db); selectedIds.forEach(id => b.delete(doc(db, type === 'student' ? 'portal_students' : 'portal_teachers', id))); await b.commit(); setSelectedIds([]); } };
            
            const [csvFile, setCsvFile] = useState(null);
            const [uploading, setUploading] = useState(false);
            const handleCsvUpload = async () => {
              if (isReadOnly) return alert("Anda tiada akses untuk memuat naik data.");
              if (!csvFile) return alert("Sila pilih fail CSV dahulu.");
              setUploading(true);
              const reader = new FileReader();
              reader.onload = async (e) => {
                  try {
                      const text = e.target.result; const lines = text.split('\n'); const batch = writeBatch(db); let count = 0;
                      lines.forEach((line, index) => {
                          if (index === 0 || !line.trim()) return; 
                          const cols = line.split(',').map(c => c.trim());
                          if (cols.length < 2) return; 
                          const ref = doc(collection(db, type === 'student' ? 'portal_students' : 'portal_teachers')); let data = {};
                          if (type === 'teacher') {
                              const name = cols[0]; const email = cols[1]; const roleRaw = cols[2] ? cols[2].toLowerCase() : 'guru'; const position = cols[3] || 'GAB';
                              if (!name || !email) return;
                              let sysRole = 'guru';
                              if (roleRaw.includes('admin')) sysRole = 'admin';
                              else if (roleRaw.includes('pentadbir')) sysRole = 'pentadbir';
                              data = { name, email, role: sysRole, position, createdAt: new Date().toISOString() };
                          } else {
                              const name = cols[0]; const className = cols[1] || 'Umum'; if (!name) return;
                              const rmt = cols[2] ? cols[2].trim() : 'Tidak';
                              data = { name, class: className, rmt, createdAt: new Date().toISOString() };
                          }
                          batch.set(ref, data); count++;
                      });
                      if (count > 0) { await batch.commit(); alert(`${count} rekod berjaya dimuat naik!`); setCsvFile(null); } else { alert("Tiada data sah ditemui."); }
                  } catch (err) { console.error(err); alert("Ralat memproses fail."); }
                  setUploading(false);
              };
              reader.readAsText(csvFile);
          };

            return (<div className="grid lg:grid-cols-12 gap-8 h-full">
                {!isReadOnly && <div className="lg:col-span-4 bg-white p-6 rounded-xl border h-fit"><h3 className="font-bold mb-4">{editingId ? 'Edit' : 'Tambah'} {type}</h3><form onSubmit={save} className="space-y-3"><input className="inp" placeholder="Nama" value={newRec.name || ''} onChange={e => setNewRec({ ...newRec, name: e.target.value })} required />
                {type === 'student' ? 
                  <>
                    <input className="inp" placeholder="Kelas" value={newRec.class || ''} onChange={e => setNewRec({ ...newRec, class: e.target.value })} required />
                    <select className="inp mt-2" value={newRec.rmt || 'Tidak'} onChange={e => setNewRec({ ...newRec, rmt: e.target.value })}>
                        <option value="Tidak">Bukan RMT</option>
                        <option value="Layak">RMT Layak</option>
                    </select>
                  </>
                  : 
                  <>
                    <input className="inp" placeholder="Email" value={newRec.email || ''} onChange={e => setNewRec({ ...newRec, email: e.target.value })} required />
                    <div className="grid grid-cols-2 gap-2">
                        <select className="inp" value={newRec.role||'guru'} onChange={e=>setNewRec({...newRec, role:e.target.value})}><option value="guru">Guru Biasa</option><option value="pentadbir">Pentadbir</option><option value="admin">Admin</option></select>
                        <select className="inp" value={newRec.position||'GAB'} onChange={e=>setNewRec({...newRec, position:e.target.value})}><option value="GAB">GAB</option><option value="GB">Guru Besar</option><option value="GPK">GPK</option><option value="Kaunselor">Kaunselor</option></select>
                    </div>
                  </>
                }
                <button className="w-full bg-indigo-600 text-white py-2 rounded font-bold">Simpan</button></form><div className="mt-6 border-t pt-4"><h3 className="font-bold mb-2">Upload CSV</h3><div className="text-xs text-slate-500 mb-3 bg-blue-50 p-2 rounded border border-blue-100"><p className="font-bold text-blue-700 mb-1 flex items-center gap-1"><Info size={12}/> Panduan Kolum CSV:</p>{type === 'student' ? (<><code className="block font-mono text-[10px] bg-white p-1 rounded border border-blue-100 text-slate-600 mb-1">Nama, Kelas, RMT</code><p className="text-[9px] italic text-slate-400">*RMT: "Layak" atau "Tidak"</p></>) : (<><code className="block font-mono text-[10px] bg-white p-1 rounded border border-blue-100 text-slate-600 mb-1">Nama, Email, Role, Jawatan</code><p className="text-[9px] italic text-slate-400">*Role: "admin", "pentadbir", atau "guru"</p></>)}<p className="mt-1 text-[9px] italic text-slate-400">*Baris pertama (header) akan diabaikan.</p></div><input type="file" onChange={e => setCsvFile(e.target.files[0])} className="text-xs mb-2"/><button onClick={handleCsvUpload} disabled={uploading} className="w-full bg-green-600 text-white py-2 rounded font-bold text-xs">{uploading ? 'Uploading...' : 'Upload CSV'}</button></div></div>}
                <div className={`${isReadOnly ? 'col-span-12' : 'lg:col-span-8'} bg-white rounded-xl border flex flex-col h-full`}><div className="p-4 border-b flex justify-between items-center"><div><h3 className="font-bold">Senarai {type}</h3><p className="text-xs text-slate-500">Jumlah: {processedData.length}</p></div>{type === 'student' && <div className="flex gap-2"><select className="border p-1 rounded text-xs" value={filterClass} onChange={e => setFilterClass(e.target.value)}><option value="">Semua Kelas</option>{classList.map(c => <option key={c} value={c}>{c}</option>)}</select><button onClick={() => setSortOrder(p => p === 'asc' ? 'desc' : 'asc')} className="border p-1 rounded text-xs font-bold w-20">{sortOrder === 'asc' ? 'A-Z' : 'Z-A'}</button></div>}{selectedIds.length > 0 && <button onClick={bulkDel} className="bg-red-50 text-red-600 px-3 py-1 rounded text-xs font-bold">Padam {selectedIds.length}</button>}</div><div className="flex-1 overflow-y-auto"><table className="w-full text-sm text-left"><thead className="bg-slate-50 text-xs uppercase sticky top-0"><tr><th className="p-3 w-10"></th><th className="p-3">Nama</th><th className="p-3">Info</th>{type === 'student' && <th className="p-3">RMT</th>}<th className="p-3 text-right"></th></tr></thead><tbody className="divide-y">{processedData.map(d => <tr key={d.id} className="hover:bg-slate-50"><td className="p-3"><input type="checkbox" checked={selectedIds.includes(d.id)} onChange={() => setSelectedIds(p => p.includes(d.id) ? p.filter(x => x !== d.id) : [...p, d.id])} /></td><td className="p-3 font-bold">{d.name}</td><td className="p-3">{type === 'student' ? <span className="bg-emerald-100 text-emerald-800 text-xs px-2 py-1 rounded font-bold">{d.class}</span> : <div>{d.email}<br/><span className="text-[10px] bg-slate-100 px-1 rounded">{d.role}</span></div>}</td>{type === 'student' && <td className="p-3"><span className={`text-xs font-bold px-2 py-1 rounded ${d.rmt === 'Layak' ? 'bg-orange-100 text-orange-700' : 'bg-slate-100 text-slate-400'}`}>{d.rmt || 'Tidak'}</span></td>}<td className="p-3 text-right">{!isReadOnly && <div className="flex justify-end gap-2"><button onClick={() => { setNewRec(d); setEditingId(d.id); }} className="text-blue-400"><Edit3 size={16} /></button><button onClick={() => del(d.id)} className="text-red-400"><Trash2 size={16} /></button></div>}</td></tr>)}</tbody></table></div></div></div>);
        }

        // --- 3. DASHBOARD & MAIN ---

        function Dashboard({ userData, apps, students, teachers, tasks, setView, setTargetClass }) {
          const role = userData.role;
          const showStats = ['admin', 'pentadbir', 'guru'].includes(role);
          const stats = [ { l: 'Aplikasi', v: apps.length, i: LayoutDashboard, c: 'text-blue-600', b: 'bg-blue-50' }, { l: 'Murid', v: showStats ? students.length : '-', i: GraduationCap, c: 'text-emerald-600', b: 'bg-emerald-50' }, { l: 'Guru', v: showStats ? teachers.length : '-', i: Users, c: 'text-indigo-600', b: 'bg-indigo-50' } ];
          const [todayAttendance, setTodayAttendance] = useState([]);
          const [loadingAtt, setLoadingAtt] = useState(true);
          const today = new Date().toISOString().split('T')[0];
          
          // State for popup details
          const [viewClass, setViewClass] = useState(null);
          const [viewTask, setViewTask] = useState(null); // State baru untuk popup tugasan di dashboard
          
          // --- ADMIN RESET STATES ---
          const [showResetConfirm, setShowResetConfirm] = useState(false);
          const [isResetting, setIsResetting] = useState(false);

          useEffect(() => { const unsub = onSnapshot(query(collection(db, 'portal_attendance'), where('date', '==', today)), s => { setTodayAttendance(s.docs.map(d => d.data())); setLoadingAtt(false); }, e => setLoadingAtt(false)); return () => unsub(); }, []);
          
          // Reset target class on mount
          useEffect(() => { if(setTargetClass) setTargetClass(null); }, []);

          const allClasses = [...new Set(students.map(s => s.class))].sort();
          
          // Calculate overall percentage
          const totalSchoolStudents = todayAttendance.reduce((acc, curr) => acc + (curr.stats?.total || 0), 0);
          const totalSchoolPresent = todayAttendance.reduce((acc, curr) => acc + (curr.stats?.hadir || 0), 0);
          const overallPercentage = totalSchoolStudents > 0 ? ((totalSchoolPresent / totalSchoolStudents) * 100).toFixed(2) : "0.00";

          // Calculate RMT Stats
          const rmtStudents = students.filter(s => s.rmt === 'Layak');
          const rmtTotal = rmtStudents.length;
          let rmtPresent = 0;
          let rmtAbsentList = [];

          // Flatten attendance records for lookup
          const attendanceStatus = {};
          todayAttendance.forEach(record => {
              if(record.records) Object.assign(attendanceStatus, record.records);
          });

          rmtStudents.forEach(student => {
              const status = attendanceStatus[student.id];
              if(status === 'Hadir') rmtPresent++;
              if(status === 'Tidak Hadir') rmtAbsentList.push(student);
          });

          const rmtPercent = rmtTotal > 0 ? Math.round((rmtPresent / rmtTotal) * 100) : 0;

          const getAbsentNames = (record) => {
              if (!record || !record.records) return [];
              const absentIds = Object.entries(record.records)
                  .filter(([id, status]) => status === 'Tidak Hadir' || status === 'Lewat') 
                  .map(([id]) => id);
              // Filter status 'Tidak Hadir' strictly for absent list
              const strictAbsentIds = Object.entries(record.records)
                  .filter(([id, status]) => status === 'Tidak Hadir')
                  .map(([id]) => id);
                  
              return students.filter(s => strictAbsentIds.includes(s.id)).map(s => s.name);
          };

          // --- ADMIN FACTORY RESET LOGIC ---
          const performFactoryReset = async () => {
              setIsResetting(true);
              try {
                  const collectionsToReset = [
                      'portal_apps', 'portal_tasks', 'portal_reports', 
                      'portal_assignments', 'portal_events', 'portal_attendance', 
                      'portal_mmi', 'portal_timetables', 'portal_access_logs',
                      'portal_students', 'portal_teachers', 'portal_settings'
                  ];
                  
                  for (const colName of collectionsToReset) {
                      const q = query(collection(db, colName));
                      const snapshot = await getDocs(q);
                      const chunk = 400; 
                      for (let i = 0; i < snapshot.docs.length; i += chunk) {
                          const batch = writeBatch(db);
                          snapshot.docs.slice(i, i + chunk).forEach(doc => batch.delete(doc.ref));
                          await batch.commit();
                      }
                  }
                  alert("Sistem berjaya di-reset ke tetapan asal!");
                  window.location.reload();
              } catch (error) {
                  console.error("Reset failed: ", error);
                  alert("Gagal melakukan reset: " + error.message);
              } finally {
                  setIsResetting(false);
                  setShowResetConfirm(false);
              }
          };

          return (
            <div className="max-w-6xl mx-auto space-y-8 animate-fade-in">
               <div className="bg-white rounded-xl p-8 border border-slate-200 shadow-sm"><h2 className="text-2xl font-bold text-slate-800 mb-2">Hai, {userData.name}!</h2><p className="text-slate-500">Selamat datang ke papan pemuka.</p></div>
               <div className="grid grid-cols-1 md:grid-cols-3 gap-6">{stats.map((s, i) => (<div key={i} className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex items-center gap-4"><div className={`w-14 h-14 rounded-full flex items-center justify-center ${s.b} ${s.c}`}><s.i className="w-7 h-7" /></div><div><p className="text-sm font-medium text-slate-500">{s.l}</p><h3 className="text-3xl font-bold text-slate-800">{s.v}</h3></div></div>))}</div>
               
               <div className="bg-white rounded-xl border border-slate-200 p-6 shadow-sm">
                   <div className="flex justify-between items-center mb-4">
                        <h3 className="font-bold text-slate-800 flex items-center gap-2"><UserCheck className="w-5 h-5 text-indigo-600"/> Status Kehadiran Hari Ini</h3>
                        <div className="bg-indigo-50 text-indigo-700 px-3 py-1 rounded-lg text-sm font-bold border border-indigo-100">
                            Peratus Sekolah: {overallPercentage}%
                        </div>
                   </div>
                   
                   {loadingAtt ? <div className="flex justify-center p-4"><Loader2 className="w-6 h-6 animate-spin text-slate-400"/></div> : 
                   <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3">
                       {allClasses.length === 0 ? <p className="col-span-full text-slate-400 italic text-sm text-center">Tiada data kelas.</p> : 
                       allClasses.map(className => { 
                           const record = todayAttendance.find(a => a.className === className);
                           const isSubmitted = !!record;
                           let percentage = "0.00";
                           
                           if (isSubmitted && record.stats.total > 0) {
                               percentage = ((record.stats.hadir / record.stats.total) * 100).toFixed(2);
                           }

                           return (
                               <div 
                                   key={className} 
                                   onClick={() => {
                                       if (isSubmitted) {
                                           setViewClass(record);
                                       } else {
                                           // Navigate to attendance filler
                                           if (setTargetClass) setTargetClass(className);
                                           setView('attendance');
                                       }
                                   }}
                                   className={`p-3 rounded-lg border flex flex-col items-center justify-center text-center transition-all cursor-pointer hover:shadow-md ${isSubmitted ? 'bg-emerald-100 border-emerald-200 text-emerald-800 shadow-sm' : 'bg-slate-100 border-slate-200 text-slate-400 hover:border-indigo-300 hover:text-indigo-500'}`}
                               >
                                   <span className="font-bold text-sm">{className}</span>
                                   {isSubmitted ? (
                                       <div className="flex flex-col items-center mt-1">
                                           <span className="text-xs font-bold">{percentage}%</span>
                                           <span className="text-[10px] font-medium opacity-80">{record.stats.hadir}/{record.stats.total}</span>
                                       </div>
                                   ) : (
                                       <span className="text-[10px] font-bold uppercase mt-1">Belum</span>
                                   )}
                               </div>
                           ); 
                       })}
                   </div>}
               </div>

               {/* RMT ATTENDANCE SECTION */}
               <div className="bg-white rounded-xl border border-slate-200 p-6 shadow-sm mt-6">
                    <div className="flex justify-between items-center mb-4">
                        <h3 className="font-bold text-slate-800 flex items-center gap-2"><Utensils className="w-5 h-5 text-orange-600"/> Kehadiran RMT Keseluruhan</h3>
                        <div className="bg-orange-50 text-orange-700 px-3 py-1 rounded-lg text-sm font-bold border border-orange-100">
                            Hadir: {rmtPresent} / {rmtTotal} ({rmtPercent}%)
                        </div>
                    </div>
                    
                    {rmtAbsentList.length > 0 ? (
                        <div className="overflow-x-auto">
                             <h4 className="font-bold text-sm text-red-600 mb-2 border-b border-red-100 pb-1">Senarai Murid RMT Tidak Hadir ({rmtAbsentList.length})</h4>
                             <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
                                {rmtAbsentList.map((s, i) => (
                                    <div key={i} className="flex items-center gap-2 text-sm text-slate-700 bg-red-50 p-2 rounded border border-red-100">
                                        <span className="font-bold text-red-500">{i+1}.</span>
                                        <div>
                                            <span className="font-bold block">{s.name}</span>
                                            <span className="text-xs text-slate-500">{s.class}</span>
                                        </div>
                                    </div>
                                ))}
                             </div>
                        </div>
                    ) : (
                        <p className="text-emerald-600 text-sm italic font-medium bg-emerald-50 p-3 rounded border border-emerald-100">Semua murid RMT hadir (berdasarkan data kehadiran kelas yang dihantar).</p>
                    )}
                </div>

               {/* CLASS DETAILS MODAL */}
               {viewClass && (
                   <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 animate-fade-in">
                       <div className="bg-white p-6 rounded-xl w-80 md:w-96 shadow-2xl max-h-[80vh] flex flex-col">
                           <div className="flex justify-between items-center mb-4 border-b pb-2">
                               <h3 className="font-bold text-lg text-slate-800">{viewClass.className}</h3>
                               <button onClick={() => setViewClass(null)} className="text-slate-400 hover:text-red-500"><X size={20}/></button>
                           </div>
                           <div className="mb-4 text-center">
                               <div className="text-3xl font-bold text-indigo-600 mb-1">{Math.round((viewClass.stats.hadir / viewClass.stats.total) * 100)}%</div>
                               <div className="text-xs text-slate-500 font-bold uppercase tracking-wider">Kehadiran</div>
                           </div>
                           <div className="flex-1 overflow-y-auto">
                               <h4 className="font-bold text-sm text-red-600 mb-2 border-b border-red-100 pb-1">Senarai Tidak Hadir ({viewClass.stats.tidakHadir})</h4>
                               {getAbsentNames(viewClass).length > 0 ? (
                                   <ul className="space-y-2">
                                       {getAbsentNames(viewClass).map((name, idx) => (
                                           <li key={idx} className="text-sm text-slate-700 flex items-start gap-2">
                                               <span className="text-red-400 font-bold"></span> {name}
                                           </li>
                                       ))}
                                   </ul>
                               ) : (
                                   <p className="text-sm text-emerald-600 italic">Semua hadir / Tiada yang tidak hadir.</p>
                               )}
                           </div>
                           <button onClick={() => setViewClass(null)} className="mt-6 w-full bg-slate-100 text-slate-600 py-2 rounded-lg font-bold hover:bg-slate-200">Tutup</button>
                       </div>
                   </div>
               )}

               {/* TASK LIST (CLICKABLE) */}
               <div className="bg-white rounded-xl border border-slate-200 p-6">
                   <div className="flex justify-between items-center mb-4">
                       <h3 className="font-bold text-slate-800 flex items-center gap-2"><Clock className="w-5 h-5 text-indigo-600"/> Tugasan Semasa</h3>
                       <button onClick={() => setView('tasks')} className="text-xs text-indigo-600 hover:underline">Lihat Semua</button>
                   </div>
                   {tasks.length === 0 ? <p className="text-slate-400 text-sm">Tiada tugasan aktif.</p> : 
                   <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                       {tasks.slice(0, 6).map(task => {
                           const diff = new Date(task.deadline) - new Date();
                           const days = Math.ceil(diff / (1000 * 60 * 60 * 24));
                           const isUrgent = days <= 3 && days >= 0;
                           return (
                               <div 
                                   key={task.id} 
                                   onClick={() => setViewTask(task)} // Make Clickable
                                   className={`p-4 rounded-lg border flex flex-col justify-between cursor-pointer hover:shadow-md transition-all group ${isUrgent ? 'bg-red-50 border-red-200' : 'bg-slate-50 border-slate-100 hover:border-indigo-300'}`}
                               >
                                   <div>
                                       <h4 className="font-bold text-slate-800 text-sm mb-1 group-hover:text-indigo-700 transition-colors">{task.title}</h4>
                                       <p className="text-xs text-slate-500 mb-2">Oleh: {task.assignedBy}</p>
                                   </div>
                                   <div className="flex items-center gap-2 text-xs font-bold">
                                       <Clock className={`w-3 h-3 ${isUrgent ? 'text-red-500' : 'text-slate-400'}`}/>
                                       <span className={isUrgent ? 'text-red-600' : 'text-slate-600'}>{days < 0 ? 'Tamat' : `${days} hari lagi`}</span>
                                   </div>
                               </div>
                           )
                       })}
                   </div>}
               </div>

               {/* TASK DETAIL POPUP (DASHBOARD) */}
               {viewTask && (
                    <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 animate-fade-in backdrop-blur-sm">
                        <div className="bg-white rounded-2xl w-full max-w-lg shadow-2xl flex flex-col max-h-[90vh]">
                            <div className="p-6 border-b border-slate-100 flex justify-between items-start bg-slate-50 rounded-t-2xl">
                                <div>
                                    <span className="text-[10px] font-bold uppercase tracking-wider text-slate-500 bg-white border px-2 py-1 rounded">Arahan {viewTask.assignedByRole}</span>
                                    <h3 className="text-xl font-bold text-slate-800 mt-2 leading-tight">{viewTask.title}</h3>
                                </div>
                                <button onClick={() => setViewTask(null)} className="text-slate-400 hover:text-red-500 bg-white p-1 rounded-full border hover:bg-red-50 transition-colors"><X size={20}/></button>
                            </div>
                            
                            <div className="p-6 overflow-y-auto space-y-6">
                                <div className="grid grid-cols-2 gap-4 text-sm">
                                    <div className="bg-slate-50 p-3 rounded-lg border border-slate-100">
                                        <span className="block text-xs text-slate-400 uppercase font-bold mb-1">Dihantar Oleh</span>
                                        <span className="font-bold text-slate-700">{viewTask.assignedBy}</span>
                                    </div>
                                    <div className="bg-slate-50 p-3 rounded-lg border border-slate-100">
                                        <span className="block text-xs text-slate-400 uppercase font-bold mb-1">Tarikh Akhir</span>
                                        <span className={`font-bold ${new Date(viewTask.deadline) < new Date() ? 'text-red-600' : 'text-emerald-600'}`}>{formatDate(viewTask.deadline)}</span>
                                    </div>
                                    <div className="bg-slate-50 p-3 rounded-lg border border-slate-100 col-span-2">
                                        <span className="block text-xs text-slate-400 uppercase font-bold mb-1">Kepada</span>
                                        <span className="font-bold text-slate-700">{viewTask.assignTo}</span>
                                    </div>
                                </div>

                                {viewTask.description ? (
                                    <div>
                                        <h4 className="text-sm font-bold text-slate-700 uppercase mb-2 border-b pb-1">Butiran Tugasan</h4>
                                        <p className="text-slate-600 text-sm whitespace-pre-wrap leading-relaxed">{viewTask.description}</p>
                                    </div>
                                ) : (
                                    <p className="text-slate-400 italic text-sm text-center">Tiada deskripsi tambahan.</p>
                                )}

                                {viewTask.link && (
                                    <a 
                                        href={viewTask.link} 
                                        target="_blank" 
                                        rel="noopener noreferrer"
                                        className="flex items-center justify-center gap-2 w-full bg-blue-50 text-blue-600 border border-blue-200 py-3 rounded-xl font-bold hover:bg-blue-100 transition-colors"
                                    >
                                        <LinkIcon size={18}/> Buka Pautan / Lampiran
                                    </a>
                                )}
                            </div>

                            <div className="p-4 border-t border-slate-100 bg-slate-50 rounded-b-2xl">
                                <button onClick={() => setViewTask(null)} className="w-full bg-white border border-slate-300 text-slate-600 py-2 rounded-lg font-bold hover:bg-slate-100 text-sm">Tutup</button>
                            </div>
                        </div>
                    </div>
                )}
               
               {/* --- ADMIN FACTORY RESET BUTTON --- */}
               {role === 'admin' && (
                  <div className="mt-8 p-6 bg-red-50 border border-red-100 rounded-xl">
                      <h3 className="font-bold text-red-800 mb-2 flex items-center gap-2"><AlertTriangle className="w-5 h-5"/> Zon Admin</h3>
                      <p className="text-sm text-red-600 mb-4">Amaran: Tindakan ini akan memadam <b>SEMUA</b> data aplikasi (Murid, Guru, Laporan, Kehadiran, dll). Data tidak boleh dikembalikan.</p>
                      <button onClick={() => setShowResetConfirm(true)} className="bg-red-600 text-white px-4 py-2 rounded-lg font-bold shadow-sm hover:bg-red-700 transition-colors flex items-center gap-2"><Trash2 className="w-4 h-4"/> Factory Reset</button>
                  </div>
               )}

               {/* --- RESET CONFIRMATION MODAL --- */}
               {showResetConfirm && (
                  <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 animate-fade-in">
                      <div className="bg-white p-6 rounded-xl w-96 shadow-2xl border-2 border-red-100">
                          <div className="flex flex-col items-center text-center mb-6">
                              <div className="w-16 h-16 bg-red-100 text-red-600 rounded-full flex items-center justify-center mb-4"><AlertTriangle className="w-8 h-8"/></div>
                              <h3 className="font-bold text-xl text-slate-800">Pasti Reset Kilang?</h3>
                              <p className="text-slate-500 text-sm mt-2">Semua data akan dipadam kekal. Anda tidak boleh membatalkan tindakan ini.</p>
                          </div>
                          <div className="flex gap-3">
                              <button onClick={() => setShowResetConfirm(false)} className="flex-1 px-4 py-2 rounded-lg font-bold bg-slate-100 text-slate-700 hover:bg-slate-200" disabled={isResetting}>Batal</button>
                              <button onClick={performFactoryReset} className="flex-1 px-4 py-2 rounded-lg font-bold bg-red-600 text-white hover:bg-red-700 flex justify-center items-center gap-2" disabled={isResetting}>
                                  {isResetting ? <Loader2 className="w-4 h-4 animate-spin"/> : <Trash2 className="w-4 h-4"/>}
                                  {isResetting ? 'Memadam...' : 'Ya, Reset'}
                              </button>
                          </div>
                      </div>
                  </div>
               )}
            </div>
          );
        }

        // --- MAIN APP COMPONENT (DITAMBAH UNTUK MEMBETULKAN RALAT REFERENCE) ---
        function MainApp() {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('dashboard');
            const [students, setStudents] = useState([]);
            const [teachers, setTeachers] = useState([]);
            const [apps, setApps] = useState([]);
            const [tasks, setTasks] = useState([]);
            const [reports, setReports] = useState([]);
            const [loading, setLoading] = useState(true);
            const [targetClass, setTargetClass] = useState(null); // State baru untuk pilihan kelas automatik

            // --- PWA AUTO-PROMPT STATES ---
            const [pwaEvent, setPwaEvent] = useState(null);
            const [showPwaNoti, setShowPwaNoti] = useState(false);
            const [isIOS, setIsIOS] = useState(false);

            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, async (u) => {
                    if (u) {
                        let role = 'guru';
                        try {
                             const q = query(collection(db, 'portal_teachers'), where('email', '==', u.email));
                             const snapshot = await getDocs(q);
                             if (!snapshot.empty) {
                                 const docData = snapshot.docs[0].data();
                                 role = docData.role || 'guru';
                                 // AUTO SYNC UID: Kemaskini UID jika belum ada untuk memudahkan carian Admin
                                 if (docData.uid !== u.uid) {
                                     await updateDoc(doc(db, 'portal_teachers', snapshot.docs[0].id), { uid: u.uid });
                                 }
                             } else if (u.email === 'iqbalmuhaider@gmail.com') { // Hardcoded fallback for admin
                                 role = 'admin';
                             }
                        } catch (e) {
                            console.error("Role fetch error", e);
                        }
                        
                        addDoc(collection(db, 'portal_access_logs'), {
                            uid: u.uid,
                            name: u.displayName,
                            email: u.email,
                            role: role,
                            timestamp: new Date().toISOString()
                        });

                        setUser({ ...u, role, name: u.displayName, photo: u.photoURL });
                    } else {
                        setUser(null);
                    }
                    setLoading(false);
                });
                return unsubscribe;
            }, []);

            useEffect(() => {
                if (!user) return;
                const unsubs = [
                    onSnapshot(collection(db, 'portal_students'), s => setStudents(s.docs.map(d => ({id: d.id, ...d.data()})))),
                    onSnapshot(collection(db, 'portal_teachers'), s => setTeachers(s.docs.map(d => ({id: d.id, ...d.data()})))),
                    onSnapshot(collection(db, 'portal_apps'), s => setApps(s.docs.map(d => ({id: d.id, ...d.data()})))),
                    onSnapshot(collection(db, 'portal_tasks'), s => setTasks(s.docs.map(d => ({id: d.id, ...d.data()})))),
                    onSnapshot(collection(db, 'portal_reports'), s => setReports(s.docs.map(d => ({id: d.id, ...d.data()}))))
                ];
                return () => unsubs.forEach(u => u());
            }, [user]);

            // --- PWA AUTO DETECTION LOGIC ---
            useEffect(() => {
                // 1. Android / Desktop Chrome Handler
                const handler = (e) => {
                    e.preventDefault();
                    setPwaEvent(e);
                    setShowPwaNoti(true);
                };
                window.addEventListener('beforeinstallprompt', handler);

                // 2. iOS Safari Handler
                const isIosDevice = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
                const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
                
                if (isIosDevice && !isStandalone) {
                    setIsIOS(true);
                    setShowPwaNoti(true);
                }

                return () => window.removeEventListener('beforeinstallprompt', handler);
            }, []);

            const installPwa = async () => {
                if (!pwaEvent) return;
                pwaEvent.prompt();
                const { outcome } = await pwaEvent.userChoice;
                if (outcome === 'accepted') {
                    setShowPwaNoti(false);
                }
                setPwaEvent(null);
            };

            const handleLogin = async () => {
                try { await signInWithPopup(auth, googleProvider); } catch (e) { alert(e.message); }
            };

            const handleLogout = async () => {
                await signOut(auth);
                window.location.reload();
            };

            if (loading) return <div className="h-screen flex items-center justify-center"><Loader2 className="w-10 h-10 animate-spin text-indigo-600"/></div>;

            if (!user) return <LoginScreen onGoogleLogin={handleLogin} />;

            return (
                <div className="flex flex-col-reverse md:flex-row h-screen bg-slate-50 overflow-hidden">
                    <Sidebar userData={user} view={view} setView={setView} logout={handleLogout} />
                    <div className="flex-1 flex flex-col min-w-0 overflow-hidden">
                        <Header userData={user} view={view} />
                        <main className="flex-1 overflow-y-auto p-4 md:p-6 no-scrollbar">
                            {view === 'dashboard' && <Dashboard 
                                userData={user} apps={apps} students={students} teachers={teachers} tasks={tasks} 
                                setView={setView} 
                                setTargetClass={setTargetClass} // Pass setter ke Dashboard
                            />}
                            {view === 'mmi' && <MMIManager userData={user} currentUid={user.uid} students={students} teachers={teachers} />}
                            {view === 'timetable' && <TimetableManager userData={user} currentUid={user.uid} students={students} teachers={teachers} />}
                            {view === 'apps' && <AppGallery apps={apps} />}
                            {view === 'takwim' && <TakwimManager canEdit={['admin', 'pentadbir'].includes(user.role)} role={user.role} currentUid={user.uid} />}
                            {view === 'attendance' && <AttendanceManager 
                                students={students} userData={user} 
                                preSelectedClass={targetClass} // Pass getter ke AttendanceManager
                            />}
                            {view === 'tasks' && <TaskManager userData={user} tasks={tasks} currentUid={user.uid} />}
                            {view === 'reports' && <WeeklyReportManager userData={user} reports={reports} teachers={teachers} currentUid={user.uid} />}
                            {view === 'agihan' && <AgihanTugasManager teachers={teachers} canEdit={user.role === 'admin'} />}
                            {view === 'builder' && (user.role === 'admin' ? <AppBuilder apps={apps} /> : <AccessDenied />)}
                            {view === 'students' && (['admin', 'pentadbir'].includes(user.role) ? <DataTable type="student" data={students} currentUserRole={user.role} /> : <AccessDenied />)}
                            {view === 'teachers' && (['admin', 'pentadbir'].includes(user.role) ? <DataTable type="teacher" data={teachers} currentUserRole={user.role} /> : <AccessDenied />)}
                            {view === 'logs' && (user.role === 'admin' ? <SystemLogs /> : <AccessDenied />)}
                            {view === 'stats' && (user.role === 'admin' ? <UsageStats /> : <AccessDenied />)}
                        </main>
                    </div>

                    {/* --- PWA AUTO NOTIFICATION POPUP --- */}
                    {showPwaNoti && (
                        <div className="fixed inset-0 bg-black/60 z-[100] flex items-end md:items-center justify-center p-4 animate-fade-in">
                            <div className="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl relative">
                                <button onClick={() => setShowPwaNoti(false)} className="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><X /></button>
                                
                                <div className="flex flex-col items-center text-center">
                                    <div className="w-20 h-20 bg-white rounded-2xl shadow-lg border border-slate-100 flex items-center justify-center mb-4">
                                        <img src="https://i.postimg.cc/k4N1mPR1/semat-04.png" className="w-14 h-14 object-contain" />
                                    </div>
                                    <h3 className="text-xl font-bold text-slate-800 mb-2">Pasang Aplikasi SkolaHub</h3>
                                    <p className="text-slate-500 text-sm mb-6">Akses sistem SK Masjid Tanah dengan lebih pantas terus dari Home Screen anda.</p>
                                    
                                    {isIOS ? (
                                        <div className="w-full bg-slate-50 p-4 rounded-xl text-left text-sm border border-slate-200">
                                            <p className="font-bold text-slate-700 mb-2 flex items-center gap-2"><div className="w-2 h-2 bg-indigo-500 rounded-full"></div> Pengguna iPhone / iPad:</p>
                                            <ol className="list-decimal pl-4 space-y-2 text-slate-600 text-xs">
                                                <li>Tekan butang <span className="font-bold"><Share className="inline w-3 h-3"/> Share</span> di bahagian bawah browser.</li>
                                                <li>Skrol ke bawah & pilih <span className="font-bold">Add to Home Screen</span>.</li>
                                                <li>Tekan <span className="font-bold">Add</span> di penjuru atas.</li>
                                            </ol>
                                        </div>
                                    ) : (
                                        <button onClick={installPwa} className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl shadow-lg flex items-center justify-center gap-2 transform active:scale-95 transition-all">
                                            <Download size={20} />
                                            Pasang Sekarang
                                        </button>
                                    )}
                                    
                                    <button onClick={() => setShowPwaNoti(false)} className="mt-4 text-xs text-slate-400 font-bold hover:text-slate-600 uppercase tracking-wider">Nanti Dulu</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const styles = `.lbl{display:block;font-size:0.75rem;font-weight:700;color:#64748b;margin-bottom:0.5rem;text-transform:uppercase}.inp{width:100%;padding:0.6rem 0.8rem;border:1px solid #e2e8f0;border-radius:0.5rem;font-size:0.875rem;outline:none;background-color:#f8fafc;color:#1e293b}.inp:focus{background-color:white;border-color:#4f46e5}@keyframes fade-in{from{opacity:0}to{opacity:1}}@keyframes scale-up{from{transform:scale(0.95);opacity:0}to{transform:scale(1);opacity:1}}.animate-fade-in{animation:fade-in 0.2s ease-out}.animate-scale-up{animation:scale-up 0.2s cubic-bezier(0.16,1,0.3,1)}.diagonal-stripe{background-image:linear-gradient(45deg,#fcd34d 25%,#fbbf24 25%,#fbbf24 50%,#fcd34d 50%,#fcd34d 75%,#fbbf24 75%,#fbbf24 100%);background-size:10px 10px}`;

        // RENDER ENTRY
        const root = createRoot(document.getElementById('root'));
        root.render(<MainApp />);
    </script>
</body>
</html>
